var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
(function (factory) {
    if (typeof module === 'object' && typeof module.exports === 'object') {
        var v = factory(require, exports); if (v !== undefined) module.exports = v;
    }
    else if (typeof define === 'function' && define.amd) {
        define(["require", "exports", './async/Task', './request/has', './Registry', './load'], factory);
    }
})(function (require, exports) {
    "use strict";
    var Task_1 = require('./async/Task');
    var has_1 = require('./request/has');
    var Registry_1 = require('./Registry');
    var load_1 = require('./load');
    var FilterRegistry = (function (_super) {
        __extends(FilterRegistry, _super);
        function FilterRegistry() {
            _super.apply(this, arguments);
        }
        FilterRegistry.prototype.register = function (test, value, first) {
            var entryTest;
            if (typeof test === 'string') {
                entryTest = function (response, url, options) {
                    return test === url;
                };
            }
            else if (test instanceof RegExp) {
                entryTest = function (response, url, options) {
                    return test.test(url);
                };
            }
            else {
                entryTest = test;
            }
            return _super.prototype.register.call(this, entryTest, value, first);
        };
        return FilterRegistry;
    }(Registry_1.default));
    exports.FilterRegistry = FilterRegistry;
    var defaultProvider = './request/xhr';
    if (has_1.default('host-node')) {
        defaultProvider = './request/node';
    }
    var ProviderRegistry = (function (_super) {
        __extends(ProviderRegistry, _super);
        function ProviderRegistry() {
            var _this = this;
            _super.call(this);
            var deferRequest = function (url, options) {
                var canceled = false;
                var actualResponse;
                return new Task_1.default(function (resolve, reject) {
                    _this._providerPromise.then(function (provider) {
                        if (canceled) {
                            return;
                        }
                        actualResponse = provider(url, options);
                        actualResponse.then(resolve, reject);
                    });
                }, function () {
                    if (!canceled) {
                        canceled = true;
                    }
                    if (actualResponse) {
                        actualResponse.cancel();
                    }
                });
            };
            // The first request to hit the default value will kick off the import of the default
            // provider. While that import is in-flight, subsequent requests will queue up while
            // waiting for the provider to be fulfilled.
            this._defaultValue = function (url, options) {
                _this._providerPromise = load_1.default(require, defaultProvider).then(function (_a) {
                    var providerModule = _a[0];
                    _this._defaultValue = providerModule.default;
                    return providerModule.default;
                });
                _this._defaultValue = deferRequest;
                return deferRequest(url, options);
            };
        }
        ProviderRegistry.prototype.register = function (test, value, first) {
            var entryTest;
            if (typeof test === 'string') {
                entryTest = function (url, options) {
                    return test === url;
                };
            }
            else if (test instanceof RegExp) {
                entryTest = function (url, options) {
                    return test.test(url);
                };
            }
            else {
                entryTest = test;
            }
            return _super.prototype.register.call(this, entryTest, value, first);
        };
        return ProviderRegistry;
    }(Registry_1.default));
    exports.ProviderRegistry = ProviderRegistry;
    /**
     * Request filters, which filter or modify responses. The default filter simply passes a response through unchanged.
     */
    exports.filterRegistry = new FilterRegistry(function (response) {
        return response;
    });
    /**
     * Request providers, which fulfill requests.
     */
    exports.providerRegistry = new ProviderRegistry();
    /**
     * Make a request, returning a Promise that will resolve or reject when the request completes.
     */
    var request = function request(url, options) {
        if (options === void 0) { options = {}; }
        var promise = exports.providerRegistry.match(url, options)(url, options)
            .then(function (response) {
            return Task_1.default.resolve(exports.filterRegistry.match(response, url, options)(response, url, options))
                .then(function (filterResponse) {
                response.data = filterResponse.data;
                return response;
            });
        });
        return promise;
    };
    ['DELETE', 'GET', 'POST', 'PUT'].forEach(function (method) {
        request[method.toLowerCase()] = function (url, options) {
            if (options === void 0) { options = {}; }
            options = Object.create(options);
            options.method = method;
            return request(url, options);
        };
    });
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = request;
    /**
     * Add a filter that automatically parses incoming JSON responses.
     */
    exports.filterRegistry.register(function (response, url, options) {
        return typeof response.data && options && options.responseType === 'json';
    }, function (response, url, options) {
        return {
            data: JSON.parse(String(response.data))
        };
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXF1ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0lBQUEscUJBQWlCLGNBQWMsQ0FBQyxDQUFBO0lBQ2hDLG9CQUFnQixlQUFlLENBQUMsQ0FBQTtJQUdoQyx5QkFBK0IsWUFBWSxDQUFDLENBQUE7SUFDNUMscUJBQWlCLFFBQVEsQ0FBQyxDQUFBO0lBSzFCO1FBQW9DLGtDQUF1QjtRQUEzRDtZQUFvQyw4QkFBdUI7UUFvQjNELENBQUM7UUFuQkEsaUNBQVEsR0FBUixVQUFTLElBQXlDLEVBQUUsS0FBb0IsRUFBRSxLQUFlO1lBQ3hGLElBQUksU0FBZSxDQUFDO1lBRXBCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQzlCLFNBQVMsR0FBRyxVQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsT0FBTztvQkFDbEMsTUFBTSxDQUFDLElBQUksS0FBSyxHQUFHLENBQUM7Z0JBQ3JCLENBQUMsQ0FBQztZQUNILENBQUM7WUFDRCxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxZQUFZLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLFNBQVMsR0FBRyxVQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsT0FBTztvQkFDbEMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3ZCLENBQUMsQ0FBQztZQUNILENBQUM7WUFDRCxJQUFJLENBQUMsQ0FBQztnQkFDTCxTQUFTLEdBQXVCLElBQUksQ0FBQztZQUN0QyxDQUFDO1lBRUQsTUFBTSxDQUFDLGdCQUFLLENBQUMsUUFBUSxZQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDaEQsQ0FBQztRQUNGLHFCQUFDO0lBQUQsQ0FBQyxBQXBCRCxDQUFvQyxrQkFBUSxHQW9CM0M7SUFwQlksc0JBQWMs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QyxPQUFPLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztZQUN4QixNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM5QixDQUFDLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVIO3NCQUFlLE9BQU8sQ0FBQztJQUV2Qjs7T0FFRztJQUNILHNCQUFjLENBQUMsUUFBUSxDQUN0QixVQUFVLFFBQXVCLEVBQUUsR0FBVyxFQUFFLE9BQXVCO1FBQ3RFLE1BQU0sQ0FBQyxPQUFPLFFBQVEsQ0FBQyxJQUFJLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxZQUFZLEtBQUssTUFBTSxDQUFDO0lBQzNFLENBQUMsRUFDRCxVQUFVLFFBQXVCLEVBQUUsR0FBVyxFQUFFLE9BQXVCO1FBQ3RFLE1BQU0sQ0FBQztZQUNOLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDdkMsQ0FBQztJQUNILENBQUMsQ0FDRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFRhc2sgZnJvbSAnLi9hc3luYy9UYXNrJztcbmltcG9ydCBoYXMgZnJvbSAnLi9yZXF1ZXN0L2hhcyc7XG5pbXBvcnQgeyBIYW5kbGUgfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnLi9Qcm9taXNlJztcbmltcG9ydCBSZWdpc3RyeSwgeyBUZXN0IH0gZnJvbSAnLi9SZWdpc3RyeSc7XG5pbXBvcnQgbG9hZCBmcm9tICcuL2xvYWQnO1xuaW1wb3J0IHsgUGFyYW1MaXN0IH0gZnJvbSAnLi9VcmxTZWFyY2hQYXJhbXMnO1xuXG5kZWNsYXJlIHZhciByZXF1aXJlOiBhbnk7XG5cbmV4cG9ydCBjbGFzcyBGaWx0ZXJSZWdpc3RyeSBleHRlbmRzIFJlZ2lzdHJ5PFJlcXVlc3RGaWx0ZXI+IHtcblx0cmVnaXN0ZXIodGVzdDogc3RyaW5nIHwgUmVnRXhwIHwgUmVxdWVzdEZpbHRlclRlc3QsIHZhbHVlOiBSZXF1ZXN0RmlsdGVyLCBmaXJzdD86IGJvb2xlYW4pOiBIYW5kbGUge1xuXHRcdGxldCBlbnRyeVRlc3Q6IFRlc3Q7XG5cblx0XHRpZiAodHlwZW9mIHRlc3QgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRlbnRyeVRlc3QgPSAocmVzcG9uc2UsIHVybCwgb3B0aW9ucykgPT4ge1xuXHRcdFx0XHRyZXR1cm4gdGVzdCA9PT0gdXJsO1xuXHRcdFx0fTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAodGVzdCBpbnN0YW5jZW9mIFJlZ0V4cCkge1xuXHRcdFx0ZW50cnlUZXN0ID0gKHJlc3BvbnNlLCB1cmwsIG9wdGlvbnMpID0+IHtcblx0XHRcdFx0cmV0dXJuIHRlc3QudGVzdCh1cmwpO1xuXHRcdFx0fTtcblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHRlbnRyeVRlc3QgPSA8UmVxdWVzdEZpbHRlclRlc3Q+IHRlc3Q7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHN1cGVyLnJlZ2lzdGVyKGVudHJ5VGVzdCwgdmFsdWUsIGZpcnN0KTtcblx0fVxufVxuXG5sZXQgZGVmYXVsdFByb3ZpZGVyOiBzdHJpbmcgPSAnLi9yZXF1ZXN0L3hocic7XG5pZiAoaGFzKCdob3N0LW5vZGUnKSkge1xuXHRkZWZhdWx0UHJvdmlkZXIgPSAnLi9yZXF1ZXN0L25vZGUnO1xufVxuXG5leHBvcnQgY2xhc3MgUHJvdmlkZXJSZWdpc3RyeSBleHRlbmRzIFJlZ2lzdHJ5PFJlcXVlc3RQcm92aWRlcj4ge1xuXHRwcml2YXRlIF9wcm92aWRlclByb21pc2U6IFByb21pc2U8UmVxdWVzdFByb3ZpZGVyPjtcblxuXHRjb25zdHJ1Y3RvcigpIHtcblx0XHRzdXBlcigpO1xuXG5cdFx0Y29uc3QgZGVmZXJSZXF1ZXN0ID0gKHVybDogc3RyaW5nLCBvcHRpb25zPzogUmVxdWVzdE9wdGlvbnMpOiBSZXNwb25zZVByb21pc2U8YW55PiA9PiB7XG5cdFx0XHRsZXQgY2FuY2VsZWQgPSBmYWxzZTtcblx0XHRcdGxldCBhY3R1YWxSZXNwb25zZTogUmVzcG9uc2VQcm9taXNlPGFueT47XG5cdFx0XHRyZXR1cm4gbmV3IFRhc2s8UmVzcG9uc2U8YW55Pj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0XHR0aGlzLl9wcm92aWRlclByb21pc2UudGhlbihmdW5jdGlvbiAocHJvdmlkZXIpIHtcblx0XHRcdFx0XHRpZiAoY2FuY2VsZWQpIHtcblx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0YWN0dWFsUmVzcG9uc2UgPSBwcm92aWRlcih1cmwsIG9wdGlvbnMpO1xuXHRcdFx0XHRcdGFjdHVhbFJlc3BvbnNlLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9LCBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghY2FuY2VsZWQpIHtcblx0XHRcdFx0XHRjYW5jZWxlZCA9IHRydWU7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKGFjdHVhbFJlc3BvbnNlKSB7XG5cdFx0XHRcdFx0YWN0dWFsUmVzcG9uc2UuY2FuY2VsKCk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdH07XG5cblx0XHQvLyBUaGUgZmlyc3QgcmVxdWVzdCB0byBoaXQgdGhlIGRlZmF1bHQgdmFsdWUgd2lsbCBraWNrIG9mZiB0aGUgaW1wb3J0IG9mIHRoZSBkZWZhdWx0XG5cdFx0Ly8gcHJvdmlkZXIuIFdoaWxlIHRoYXQgaW1wb3J0IGlzIGluLWZsaWdodCwgc3Vic2VxdWVudCByZXF1ZXN0cyB3aWxsIHF1ZXVlIHVwIHdoaWxlXG5cdFx0Ly8gd2FpdGluZyBmb3IgdGhlIHByb3ZpZGVyIHRvIGJlIGZ1bGZpbGxlZC5cblx0XHR0aGlzLl9kZWZhdWx0VmFsdWUgPSAodXJsOiBzdHJpbmcsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9ucyk6IFJlc3BvbnNlUHJvbWlzZTxhbnk+ID0+IHtcblx0XHRcdHRoaXMuX3Byb3ZpZGVyUHJvbWlzZSA9IGxvYWQocmVxdWlyZSwgZGVmYXVsdFByb3ZpZGVyKS50aGVuKChbIHByb3ZpZGVyTW9kdWxlIF06IFsgeyBkZWZhdWx0OiBSZXF1ZXN0UHJvdmlkZXIgfSBdKTogUmVxdWVzdFByb3ZpZGVyID0+IHtcblx0XHRcdFx0dGhpcy5fZGVmYXVsdFZhbHVlID0gcHJvdmlkZXJNb2R1bGUuZGVmYXVsdDtcblx0XHRcdFx0cmV0dXJuIHByb3ZpZGVyTW9kdWxlLmRlZmF1bHQ7XG5cdFx0XHR9KTtcblx0XHRcdHRoaXMuX2RlZmF1bHRWYWx1ZSA9IGRlZmVyUmVxdWVzdDtcblx0XHRcdHJldHVybiBkZWZlclJlcXVlc3QodXJsLCBvcHRpb25zKTtcblx0XHR9O1xuXHR9XG5cblx0cmVnaXN0ZXIodGVzdDogc3RyaW5nIHwgUmVnRXhwIHwgUmVxdWVzdFByb3ZpZGVyVGVzdCwgdmFsdWU6IFJlcXVlc3RQcm92aWRlciwgZmlyc3Q/OiBib29sZWFuKTogSGFuZGxlIHtcblx0XHRsZXQgZW50cnlUZXN0OiBUZXN0O1xuXG5cdFx0aWYgKHR5cGVvZiB0ZXN0ID09PSAnc3RyaW5nJykge1xuXHRcdFx0ZW50cnlUZXN0ID0gKHVybCwgb3B0aW9ucykgPT4ge1xuXHRcdFx0XHRyZXR1cm4gdGVzdCA9PT0gdXJsO1xuXHRcdFx0fTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAodGVzdCBpbnN0YW5jZW9mIFJlZ0V4cCkge1xuXHRcdFx0ZW50cnlUZXN0ID0gKHVybCwgb3B0aW9ucykgPT4ge1xuXHRcdFx0XHRyZXR1cm4gdGVzdC50ZXN0KHVybCk7XG5cdFx0XHR9O1xuXHRcdH1cblx0XHRlbHNlIHtcblx0XHRcdGVudHJ5VGVzdCA9IDxSZXF1ZXN0UHJvdmlkZXJUZXN0PiB0ZXN0O1xuXHRcdH1cblxuXHRcdHJldHVybiBzdXBlci5yZWdpc3RlcihlbnRyeVRlc3QsIHZhbHVlLCBmaXJzdCk7XG5cdH1cbn1cblxuLyoqXG4gKiBSZXF1ZXN0IGZpbHRlcnMsIHdoaWNoIGZpbHRlciBvciBtb2RpZnkgcmVzcG9uc2VzLiBUaGUgZGVmYXVsdCBmaWx0ZXIgc2ltcGx5IHBhc3NlcyBhIHJlc3BvbnNlIHRocm91Z2ggdW5jaGFuZ2VkLlxuICovXG5leHBvcnQgY29uc3QgZmlsdGVyUmVnaXN0cnkgPSBuZXcgRmlsdGVyUmVnaXN0cnkoZnVuY3Rpb24gKHJlc3BvbnNlOiBSZXNwb25zZTxhbnk+KTogUmVzcG9uc2U8YW55PiB7XG5cdHJldHVybiByZXNwb25zZTtcbn0pO1xuXG4vKipcbiAqIFJlcXVlc3QgcHJvdmlkZXJzLCB3aGljaCBmdWxmaWxsIHJlcXVlc3RzLlxuICovXG5leHBvcnQgY29uc3QgcHJvdmlkZXJSZWdpc3RyeSA9IG5ldyBQcm92aWRlclJlZ2lzdHJ5KCk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWVzdEVycm9yPFQ+IGV4dGVuZHMgRXJyb3Ige1xuXHRyZXNwb25zZTogUmVzcG9uc2U8VD47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWVzdEZpbHRlciB7XG5cdDxUPihyZXNwb25zZTogUmVzcG9uc2U8VD4sIHVybDogc3RyaW5nLCBvcHRpb25zPzogUmVxdWVzdE9wdGlvbnMpOiBUO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlcXVlc3RGaWx0ZXJUZXN0IGV4dGVuZHMgVGVzdCB7XG5cdDxUPihyZXNwb25zZTogUmVzcG9uc2U8YW55PiwgdXJsOiBzdHJpbmcsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9ucyk6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWVzdE9wdGlvbnMge1xuXHRhdXRoPzogc3RyaW5nO1xuXHRjYWNoZUJ1c3Q/OiBhbnk7XG5cdGRhdGE/OiBhbnk7XG5cdGhlYWRlcnM/OiB7IFtuYW1lOiBzdHJpbmddOiBzdHJpbmc7IH07XG5cdG1ldGhvZD86IHN0cmluZztcblx0cGFzc3dvcmQ/OiBzdHJpbmc7XG5cdHF1ZXJ5Pzogc3RyaW5nIHwgUGFyYW1MaXN0O1xuXHRyZXNwb25zZVR5cGU/OiBzdHJpbmc7XG5cdHRpbWVvdXQ/OiBudW1iZXI7XG5cdHVzZXI/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWVzdFByb3ZpZGVyIHtcblx0PFQ+KHVybDogc3RyaW5nLCBvcHRpb25zPzogUmVxdWVzdE9wdGlvbnMpOiBSZXNwb25zZVByb21pc2U8VD47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWVzdFByb3ZpZGVyVGVzdCBleHRlbmRzIFRlc3Qge1xuXHQodXJsOiBzdHJpbmcsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9ucyk6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzcG9uc2U8VD4ge1xuXHRkYXRhOiBUO1xuXHRuYXRpdmVSZXNwb25zZT86IGFueTtcblx0cmVxdWVzdE9wdGlvbnM6IFJlcXVlc3RPcHRpb25zO1xuXHRzdGF0dXNDb2RlOiBudW1iZXI7XG5cdHN0YXR1c1RleHQ/OiBzdHJpbmc7XG5cdHVybDogc3RyaW5nO1xuXG5cdGdldEhlYWRlcihuYW1lOiBzdHJpbmcpOiBzdHJpbmc7XG59XG5cbi8qKlxuICogVGhlIHRhc2sgcmV0dXJuZWQgYnkgYSByZXF1ZXN0LCB3aGljaCB3aWxsIHJlc29sdmUgdG8gYSBSZXNwb25zZVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJlc3BvbnNlUHJvbWlzZTxUPiBleHRlbmRzIFRhc2s8UmVzcG9uc2U8VD4+IHt9XG5cbi8qKlxuICogTWFrZSBhIHJlcXVlc3QsIHJldHVybmluZyBhIFByb21pc2UgdGhhdCB3aWxsIHJlc29sdmUgb3IgcmVqZWN0IHdoZW4gdGhlIHJlcXVlc3QgY29tcGxldGVzLlxuICovXG5jb25zdCByZXF1ZXN0OiB7XG5cdDxUPih1cmw6IHN0cmluZywgb3B0aW9ucz86IFJlcXVlc3RPcHRpb25zKTogUmVzcG9uc2VQcm9taXNlPFQ+O1xuXHRkZWxldGU8VD4odXJsOiBzdHJpbmcsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9ucyk6IFJlc3BvbnNlUHJvbWlzZTxUPjtcblx0Z2V0PFQ+KHVybDogc3RyaW5nLCBvcHRpb25zPzogUmVxdWVzdE9wdGlvbnMpOiBSZXNwb25zZVByb21pc2U8VD47XG5cdHBvc3Q8VD4odXJsOiBzdHJpbmcsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9ucyk6IFJlc3BvbnNlUHJvbWlzZTxUPjtcblx0cHV0PFQ+KHVybDogc3RyaW5nLCBvcHRpb25zPzogUmVxdWVzdE9wdGlvbnMpOiBSZXNwb25zZVByb21pc2U8VD47XG59ID0gPGFueT4gZnVuY3Rpb24gcmVxdWVzdDxUPih1cmw6IHN0cmluZywgb3B0aW9uczogUmVxdWVzdE9wdGlvbnMgPSB7fSk6IFJlc3BvbnNlUHJvbWlzZTxUPiB7XG5cdGNvbnN0IHByb21pc2UgPSBwcm92aWRlclJlZ2lzdHJ5Lm1hdGNoKHVybCwgb3B0aW9ucykodXJsLCBvcHRpb25zKVxuXHRcdC50aGVuKGZ1bmN0aW9uIChyZXNwb25zZTogUmVzcG9uc2U8VD4pIHtcblx0XHRcdHJldHVybiBUYXNrLnJlc29sdmUoZmlsdGVyUmVnaXN0cnkubWF0Y2gocmVzcG9uc2UsIHVybCwgb3B0aW9ucykocmVzcG9uc2UsIHVybCwgb3B0aW9ucykpXG5cdFx0XHRcdC50aGVuKGZ1bmN0aW9uIChmaWx0ZXJSZXNwb25zZTogYW55KSB7XG5cdFx0XHRcdFx0cmVzcG9uc2UuZGF0YSA9IGZpbHRlclJlc3BvbnNlLmRhdGE7XG5cdFx0XHRcdFx0cmV0dXJuIHJlc3BvbnNlO1xuXHRcdFx0XHR9KTtcblx0XHR9KTtcblxuXHRyZXR1cm4gcHJvbWlzZTtcbn07XG5cblsgJ0RFTEVURScsICdHRVQnLCAnUE9TVCcsICdQVVQnIF0uZm9yRWFjaChmdW5jdGlvbiAobWV0aG9kKSB7XG5cdCg8YW55PiByZXF1ZXN0KVttZXRob2QudG9Mb3dlckNhc2UoKV0gPSBmdW5jdGlvbiA8VD4odXJsOiBzdHJpbmcsIG9wdGlvbnM6IFJlcXVlc3RPcHRpb25zID0ge30pOiBSZXNwb25zZVByb21pc2U8VD4ge1xuXHRcdG9wdGlvbnMgPSBPYmplY3QuY3JlYXRlKG9wdGlvbnMpO1xuXHRcdG9wdGlvbnMubWV0aG9kID0gbWV0aG9kO1xuXHRcdHJldHVybiByZXF1ZXN0KHVybCwgb3B0aW9ucyk7XG5cdH07XG59KTtcblxuZXhwb3J0IGRlZmF1bHQgcmVxdWVzdDtcblxuLyoqXG4gKiBBZGQgYSBmaWx0ZXIgdGhhdCBhdXRvbWF0aWNhbGx5IHBhcnNlcyBpbmNvbWluZyBKU09OIHJlc3BvbnNlcy5cbiAqL1xuZmlsdGVyUmVnaXN0cnkucmVnaXN0ZXIoXG5cdGZ1bmN0aW9uIChyZXNwb25zZTogUmVzcG9uc2U8YW55PiwgdXJsOiBzdHJpbmcsIG9wdGlvbnM6IFJlcXVlc3RPcHRpb25zKSB7XG5cdFx0cmV0dXJuIHR5cGVvZiByZXNwb25zZS5kYXRhICYmIG9wdGlvbnMgJiYgb3B0aW9ucy5yZXNwb25zZVR5cGUgPT09ICdqc29uJztcblx0fSxcblx0ZnVuY3Rpb24gKHJlc3BvbnNlOiBSZXNwb25zZTxhbnk+LCB1cmw6IHN0cmluZywgb3B0aW9uczogUmVxdWVzdE9wdGlvbnMpOiBPYmplY3Qge1xuXHRcdHJldHVybiB7XG5cdFx0XHRkYXRhOiBKU09OLnBhcnNlKFN0cmluZyhyZXNwb25zZS5kYXRhKSlcblx0XHR9O1xuXHR9XG4pO1xuIl19