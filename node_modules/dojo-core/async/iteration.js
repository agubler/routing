(function (factory) {
    if (typeof module === 'object' && typeof module.exports === 'object') {
        var v = factory(require, exports); if (v !== undefined) module.exports = v;
    }
    else if (typeof define === 'function' && define.amd) {
        define(["require", "exports", '../Promise', '../array'], factory);
    }
})(function (require, exports) {
    "use strict";
    var Promise_1 = require('../Promise');
    var array = require('../array');
    /**
     * Processes all items and then applies the callback to each item and eventually returns an object containing the
     * processed values and callback results
     * @param items a list of synchronous/asynchronous values to process
     * @param callback a callback that maps values to synchronous/asynchronous results
     * @return a list of objects holding the synchronous values and synchronous results.
     */
    function processValuesAndCallback(items, callback) {
        return Promise_1.default.all(items)
            .then(function (results) {
            var pass = Array.prototype.map.call(results, callback);
            return Promise_1.default.all(pass)
                .then(function (pass) {
                return { values: results, results: pass };
            });
        });
    }
    /**
     * Finds the index of the next value in a sparse array-like object
     * @param list the sparse array-like object
     * @param offset the starting offset
     * @return {number} the offset of the next index with a value; or -1 if not found
     */
    function findNextValueIndex(list, offset) {
        if (offset === void 0) { offset = -1; }
        offset++;
        for (var length_1 = list.length; offset < length_1; offset++) {
            if (offset in list) {
                return offset;
            }
        }
        return -1;
    }
    function findLastValueIndex(list, offset) {
        offset = (offset === undefined ? list.length : offset) - 1;
        for (; offset >= 0; offset--) {
            if (offset in list) {
                return offset;
            }
        }
        return -1;
    }
    function generalReduce(findNextIndex, items, callback, initialValue) {
        var hasInitialValue = arguments.length > 3;
        return Promise_1.default.all(items)
            .then(function (results) {
            return new Promise_1.default(function (resolve, reject) {
                var i;
                function next(currentValue) {
                    i = findNextIndex(items, i);
                    if (i >= 0) {
                        var result = callback(currentValue, results[i], i, results);
                        if (result.then) {
                            result.then(next, reject);
                        }
                        else {
                            next(result);
                        }
                    }
                    else {
                        resolve(currentValue);
                    }
                }
                ;
                var value;
                if (hasInitialValue) {
                    value = initialValue;
                }
                else {
                    i = findNextIndex(items);
                    if (i < 0) {
                        throw new Error('reduce array with no initial value');
                    }
                    value = results[i];
                }
                next(value);
            });
        });
    }
    function testAndHaltOnCondition(condition, items, callback) {
        return Promise_1.default.all(items).then(function (results) {
            return new Promise_1.default(function (resolve) {
                var result;
                var pendingCount = 0;
                for (var i = 0; i < results.length; i++) {
                    result = callback(results[i], i, results);
                    if (result === condition) {
                        return resolve(result);
                    }
                    else if (result.then) {
                        pendingCount++;
                        result.then(function (result) {
                            if (result === condition) {
                                resolve(result);
                            }
                            pendingCount--;
                            if (pendingCount === 0) {
                                resolve(!condition);
                            }
                        });
                    }
                }
                if (pendingCount === 0) {
                    resolve(!condition);
                }
            });
        });
    }
    /**
     * Test whether all elements in the array pass the provided callback
     * @param items a collection of synchronous/asynchronous values
     * @param callback a synchronous/asynchronous test
     * @return eventually returns true if all values pass; otherwise false
     */
    function every(items, callback) {
        return testAndHaltOnCondition(false, items, callback);
    }
    exports.every = every;
    /**
     * Returns an array of elements which pass the provided callback
     * @param items a collection of synchronous/asynchronous values
     * @param callback a synchronous/asynchronous test
     * @return eventually returns a new array with only values that have passed
     */
    function filter(items, callback) {
        return processValuesAndCallback(items, callback).then(function (_a) {
            var results = _a.results, values = _a.values;
            var arr = [];
            for (var i = 0; i < results.length; i++) {
                results[i] && arr.push(values[i]);
            }
            return arr;
        });
    }
    exports.filter = filter;
    /**
     * Find the first value matching a filter function
     * @param items a collection of synchronous/asynchronous values
     * @param callback a synchronous/asynchronous test
     * @return a promise eventually containing the item or undefined if a match is not found
     */
    function find(items, callback) {
        return findIndex(items, callback).then(function (i) {
            return i >= 0 ? items[i] : undefined;
        });
    }
    exports.find = find;
    /**
     * Find the first index with a value matching the filter function
     * @param items a collection of synchronous/asynchronous values
     * @param callback a synchronous/asynchronous test
     * @return a promise eventually containing the index of the matching item or -1 if a match is not found
     */
    function findIndex(items, callback) {
        // TODO we can improve this by returning immediately
        return processValuesAndCallback(items, callback).then(function (_a) {
            var results = _a.results;
            for (var i = 0; i < results.length; i++) {
                if (results[i]) {
                    return i;
                }
            }
            return -1;
        });
    }
    exports.findIndex = findIndex;
    /**
     * transform a list of items using a mapper function
     * @param items a collection of synchronous/asynchronous values
     * @param callback a synchronous/asynchronous transform function
     * @return a promise eventually containing a collection of each transformed value
     */
    function map(items, callback) {
        return processValuesAndCallback(items, callback)
            .then(function (_a) {
            var results = _a.results;
            return results;
        });
    }
    exports.map = map;
    /**
     * reduce a list of items down to a single value
     * @param items a collection of synchronous/asynchronous values
     * @param callback a synchronous/asynchronous reducer function
     * @param [initialValue] the first value to pass to the callback
     * @return a promise eventually containing a value that is the result of the reduction
     */
    function reduce(items, callback, initialValue) {
        var args = array.from(arguments);
        args.unshift(findNextValueIndex);
        return generalReduce.apply(this, args);
    }
    exports.reduce = reduce;
    function reduceRight(items, callback, initialValue) {
        var args = array.from(arguments);
        args.unshift(findLastValueIndex);
        return generalReduce.apply(this, args);
    }
    exports.reduceRight = reduceRight;
    function series(items, operation) {
        return generalReduce(findNextValueIndex, items, function (previousValue, currentValue, index, array) {
            var result = operation(currentValue, index, array);
            if (result.then) {
                return result.then(function (value) {
                    previousValue.push(value);
                    return previousValue;
                });
            }
            previousValue.push(result);
            return previousValue;
        }, []);
    }
    exports.series = series;
    function some(items, callback) {
        return testAndHaltOnCondition(true, items, callback);
    }
    exports.some = some;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlcmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2FzeW5jL2l0ZXJhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7SUFBQSx3QkFBa0MsWUFBWSxDQUFDLENBQUE7SUFDL0MsSUFBWSxLQUFLLFdBQU0sVUFBVSxDQUFDLENBQUE7SUFHbEM7Ozs7OztPQU1HO0lBQ0gsa0NBQXdDLEtBQXlCLEVBQUUsUUFBc0I7UUFDeEYsTUFBTSxDQUFDLGlCQUFPLENBQUMsR0FBRyxDQUFJLEtBQUssQ0FBQzthQUMxQixJQUFJLENBQUMsVUFBVSxPQUFPO1lBQ3RCLElBQUksSUFBSSxHQUF1QixLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzNFLE1BQU0sQ0FBQyxpQkFBTyxDQUFDLEdBQUcsQ0FBSSxJQUFJLENBQUM7aUJBQ3pCLElBQUksQ0FBZ0MsVUFBVSxJQUFJO2dCQUNsRCxNQUFNLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQztZQUMzQyxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsNEJBQStCLElBQWtCLEVBQUUsTUFBbUI7UUFBbkIsc0JBQW1CLEdBQW5CLFVBQWtCLENBQUM7UUFDckUsTUFBTSxFQUFFLENBQUM7UUFDVCxHQUFHLENBQUMsQ0FBQyxJQUFJLFFBQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sR0FBRyxRQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQztZQUMxRCxFQUFFLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDcEIsTUFBTSxDQUFDLE1BQU0sQ0FBQztZQUNmLENBQUM7UUFDRixDQUFDO1FBQ0QsTUFBTSxDQUFDLENBQUMsQ0FBQyxD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YSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsS0FBSztZQUNsRyxJQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsWUFBWSxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztZQUVyRCxFQUFFLENBQUMsQ0FBZ0IsTUFBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLE1BQU0sQ0FBZ0IsTUFBTyxDQUFDLElBQUksQ0FBQyxVQUFVLEtBQUs7b0JBQ2pELGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQzFCLE1BQU0sQ0FBQyxhQUFhLENBQUM7Z0JBQ3RCLENBQUMsQ0FBQyxDQUFDO1lBQ0osQ0FBQztZQUVELGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDM0IsTUFBTSxDQUFDLGFBQWEsQ0FBQztRQUN0QixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDUixDQUFDO0lBZGUsY0FBTSxTQWNyQixDQUFBO0lBRUQsY0FBd0IsS0FBNEIsRUFBRSxRQUFxQjtRQUMxRSxNQUFNLENBQUMsc0JBQXNCLENBQUksSUFBSSxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRmUsWUFBSSxPQUVuQixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UsIHsgVGhlbmFibGUgfSBmcm9tICcuLi9Qcm9taXNlJztcbmltcG9ydCAqIGFzIGFycmF5IGZyb20gJy4uL2FycmF5JztcbmltcG9ydCB7IEFycmF5TGlrZSB9IGZyb20gJy4uL2FycmF5JztcblxuLyoqXG4gKiBQcm9jZXNzZXMgYWxsIGl0ZW1zIGFuZCB0aGVuIGFwcGxpZXMgdGhlIGNhbGxiYWNrIHRvIGVhY2ggaXRlbSBhbmQgZXZlbnR1YWxseSByZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIHRoZVxuICogcHJvY2Vzc2VkIHZhbHVlcyBhbmQgY2FsbGJhY2sgcmVzdWx0c1xuICogQHBhcmFtIGl0ZW1zIGEgbGlzdCBvZiBzeW5jaHJvbm91cy9hc3luY2hyb25vdXMgdmFsdWVzIHRvIHByb2Nlc3NcbiAqIEBwYXJhbSBjYWxsYmFjayBhIGNhbGxiYWNrIHRoYXQgbWFwcyB2YWx1ZXMgdG8gc3luY2hyb25vdXMvYXN5bmNocm9ub3VzIHJlc3VsdHNcbiAqIEByZXR1cm4gYSBsaXN0IG9mIG9iamVjdHMgaG9sZGluZyB0aGUgc3luY2hyb25vdXMgdmFsdWVzIGFuZCBzeW5jaHJvbm91cyByZXN1bHRzLlxuICovXG5mdW5jdGlvbiBwcm9jZXNzVmFsdWVzQW5kQ2FsbGJhY2s8VCwgVT4oaXRlbXM6IChUIHwgUHJvbWlzZTxUPilbXSwgY2FsbGJhY2s6IE1hcHBlcjxULCBVPik6IFByb21pc2U8eyB2YWx1ZXM6IFRbXTsgcmVzdWx0czogVVtdIH0+IHtcblx0cmV0dXJuIFByb21pc2UuYWxsPFQ+KGl0ZW1zKVxuXHRcdC50aGVuKGZ1bmN0aW9uIChyZXN1bHRzKSB7XG5cdFx0XHRsZXQgcGFzczogKFUgfCBQcm9taXNlPFU+KVtdID0gQXJyYXkucHJvdG90eXBlLm1hcC5jYWxsKHJlc3VsdHMsIGNhbGxiYWNrKTtcblx0XHRcdHJldHVybiBQcm9taXNlLmFsbDxVPihwYXNzKVxuXHRcdFx0XHQudGhlbjx7IHZhbHVlczogVFtdOyByZXN1bHRzOiBVW10gfT4oZnVuY3Rpb24gKHBhc3MpIHtcblx0XHRcdFx0XHRyZXR1cm4geyB2YWx1ZXM6IHJlc3VsdHMsIHJlc3VsdHM6IHBhc3MgfTtcblx0XHRcdFx0fSk7XG5cdFx0fSk7XG59XG5cbi8qKlxuICogRmluZHMgdGhlIGluZGV4IG9mIHRoZSBuZXh0IHZhbHVlIGluIGEgc3BhcnNlIGFycmF5LWxpa2Ugb2JqZWN0XG4gKiBAcGFyYW0gbGlzdCB0aGUgc3BhcnNlIGFycmF5LWxpa2Ugb2JqZWN0XG4gKiBAcGFyYW0gb2Zmc2V0IHRoZSBzdGFydGluZyBvZmZzZXRcbiAqIEByZXR1cm4ge251bWJlcn0gdGhlIG9mZnNldCBvZiB0aGUgbmV4dCBpbmRleCB3aXRoIGEgdmFsdWU7IG9yIC0xIGlmIG5vdCBmb3VuZFxuICovXG5mdW5jdGlvbiBmaW5kTmV4dFZhbHVlSW5kZXg8VD4obGlzdDogQXJyYXlMaWtlPFQ+LCBvZmZzZXQ6IG51bWJlciA9IC0xKTogbnVtYmVyIHtcblx0b2Zmc2V0Kys7XG5cdGZvciAobGV0IGxlbmd0aCA9IGxpc3QubGVuZ3RoOyBvZmZzZXQgPCBsZW5ndGg7IG9mZnNldCsrKSB7XG5cdFx0aWYgKG9mZnNldCBpbiBsaXN0KSB7XG5cdFx0XHRyZXR1cm4gb2Zmc2V0O1xuXHRcdH1cblx0fVxuXHRyZXR1cm4gLTE7XG59XG5cbmZ1bmN0aW9uIGZpbmRMYXN0VmFsdWVJbmRleDxUPihsaXN0OiBBcnJheUxpa2U8VD4sIG9mZnNldD86IG51bWJlcik6IG51bWJlciB7XG5cdG9mZnNldCA9IChvZmZzZXQgPT09IHVuZGVmaW5lZCA/IGxpc3QubGVuZ3RoIDogb2Zmc2V0KSAtIDE7XG5cdGZvciAoOyBvZmZzZXQgPj0gMDsgb2Zmc2V0LS0pIHtcblx0XHRpZiAob2Zmc2V0IGluIGxpc3QpIHtcblx0XHRcdHJldHVybiBvZmZzZXQ7XG5cdFx0fVxuXHR9XG5cdHJldHVybiAtMTtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhbFJlZHVjZTxULCBVPihmaW5kTmV4dEluZGV4OiAobGlzdDogQXJyYXlMaWtlPGFueT4sIG9mZnNldD86IG51bWJlcikgPT4gbnVtYmVyLCBpdGVtczogKFQgfCBQcm9taXNlPFQ+KVtdLCBjYWxsYmFjazogUmVkdWNlcjxULCBVPiwgaW5pdGlhbFZhbHVlPzogVSk6IFByb21pc2U8VT4ge1xuXHRjb25zdCBoYXNJbml0aWFsVmFsdWUgPSBhcmd1bWVudHMubGVuZ3RoID4gMztcblx0cmV0dXJuIFByb21pc2UuYWxsPFQ+KGl0ZW1zKVxuXHRcdC50aGVuKGZ1bmN0aW9uIChyZXN1bHRzKSB7XG5cdFx0XHRyZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuXHRcdFx0XHRsZXQgaTogbnVtYmVyO1xuXHRcdFx0XHRmdW5jdGlvbiBuZXh0KGN1cnJlbnRWYWx1ZTogVSk6IHZvaWQge1xuXHRcdFx0XHRcdGkgPSBmaW5kTmV4dEluZGV4KGl0ZW1zLCBpKTtcblx0XHRcdFx0XHRpZiAoaSA+PSAwKSB7XG5cdFx0XHRcdFx0XHRjb25zdCByZXN1bHQgPSBjYWxsYmFjayhjdXJyZW50VmFsdWUsIHJlc3VsdHNbaV0sIGksIHJlc3VsdHMpO1xuXG5cdFx0XHRcdFx0XHRpZiAoICg8VGhlbmFibGU8VT4+IHJlc3VsdCkudGhlbikge1xuXHRcdFx0XHRcdFx0XHQoPFRoZW5hYmxlPFU+PiByZXN1bHQpLnRoZW4obmV4dCwgcmVqZWN0KTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRuZXh0KDxVPiByZXN1bHQpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlIHtcblx0XHRcdFx0XHRcdHJlc29sdmUoY3VycmVudFZhbHVlKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH07XG5cblx0XHRcdFx0bGV0IHZhbHVlOiBVO1xuXHRcdFx0XHRpZiAoaGFzSW5pdGlhbFZhbHVlKSB7XG5cdFx0XHRcdFx0dmFsdWUgPSBpbml0aWFsVmFsdWU7XG5cdFx0XHRcdH1cblx0XHRcdFx0ZWxzZSB7XG5cdFx0XHRcdFx0aSA9IGZpbmROZXh0SW5kZXgoaXRlbXMpO1xuXG5cdFx0XHRcdFx0aWYgKGkgPCAwKSB7XG5cdFx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ3JlZHVjZSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUnKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0dmFsdWUgPSA8YW55PiByZXN1bHRzW2ldO1xuXHRcdFx0XHR9XG5cdFx0XHRcdG5leHQodmFsdWUpO1xuXHRcdFx0fSk7XG5cdFx0fSk7XG59XG5cbmZ1bmN0aW9uIHRlc3RBbmRIYWx0T25Db25kaXRpb248VD4oY29uZGl0aW9uOiBib29sZWFuLCBpdGVtczogKFQgfCBQcm9taXNlPFQ+KVtdLCBjYWxsYmFjazogRmlsdGVyZXI8VD4pOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0cmV0dXJuIFByb21pc2UuYWxsPFQ+KGl0ZW1zKS50aGVuKGZ1bmN0aW9uIChyZXN1bHRzKSB7XG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KGZ1bmN0aW9uKHJlc29sdmUpIHtcblx0XHRcdGxldCByZXN1bHQ6IChib29sZWFuIHwgVGhlbmFibGU8Ym9vbGVhbj4pO1xuXHRcdFx0bGV0IHBlbmRpbmdDb3VudCA9IDA7XG5cdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdHMubGVuZ3RoOyBpKyspIHtcblx0XHRcdFx0cmVzdWx0ID0gY2FsbGJhY2socmVzdWx0c1tpXSwgaSwgcmVzdWx0cyk7XG5cdFx0XHRcdGlmIChyZXN1bHQgPT09IGNvbmRpdGlvbikge1xuXHRcdFx0XHRcdHJldHVybiByZXNvbHZlKHJlc3VsdCk7XG5cdFx0XHRcdH1cblx0XHRcdFx0ZWxzZSBpZiAoKDxUaGVuYWJsZTxib29sZWFuPj4gcmVzdWx0KS50aGVuKSB7XG5cdFx0XHRcdFx0cGVuZGluZ0NvdW50Kys7XG5cdFx0XHRcdFx0KDxUaGVuYWJsZTxib29sZWFuPj4gcmVzdWx0KS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHtcblx0XHRcdFx0XHRcdGlmIChyZXN1bHQgPT09IGNvbmRpdGlvbikge1xuXHRcdFx0XHRcdFx0XHRyZXNvbHZlKHJlc3VsdCk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRwZW5kaW5nQ291bnQtLTtcblx0XHRcdFx0XHRcdGlmIChwZW5kaW5nQ291bnQgPT09IDApIHtcblx0XHRcdFx0XHRcdFx0cmVzb2x2ZSghY29uZGl0aW9uKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0aWYgKHBlbmRpbmdDb3VudCA9PT0gMCkge1xuXHRcdFx0XHRyZXNvbHZlKCFjb25kaXRpb24pO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9KTtcbn1cblxuLyoqXG4gKiBUZXN0IHdoZXRoZXIgYWxsIGVsZW1lbnRzIGluIHRoZSBhcnJheSBwYXNzIHRoZSBwcm92aWRlZCBjYWxsYmFja1xuICogQHBhcmFtIGl0ZW1zIGEgY29sbGVjdGlvbiBvZiBzeW5jaHJvbm91cy9hc3luY2hyb25vdXMgdmFsdWVzXG4gKiBAcGFyYW0gY2FsbGJhY2sgYSBzeW5jaHJvbm91cy9hc3luY2hyb25vdXMgdGVzdFxuICogQHJldHVybiBldmVudHVhbGx5IHJldHVybnMgdHJ1ZSBpZiBhbGwgdmFsdWVzIHBhc3M7IG90aGVyd2lzZSBmYWxzZVxuICovXG5leHBvcnQgZnVuY3Rpb24gZXZlcnk8VD4oaXRlbXM6IChUIHwgUHJvbWlzZTxUPilbXSwgY2FsbGJhY2s6IEZpbHRlcmVyPFQ+KTogUHJvbWlzZTxib29sZWFuPiB7XG5cdHJldHVybiB0ZXN0QW5kSGFsdE9uQ29uZGl0aW9uKGZhbHNlLCBpdGVtcywgY2FsbGJhY2spO1xufVxuXG4vKipcbiAqIFJldHVybnMgYW4gYXJyYXkgb2YgZWxlbWVudHMgd2hpY2ggcGFzcyB0aGUgcHJvdmlkZWQgY2FsbGJhY2tcbiAqIEBwYXJhbSBpdGVtcyBhIGNvbGxlY3Rpb24gb2Ygc3luY2hyb25vdXMvYXN5bmNocm9ub3VzIHZhbHVlc1xuICogQHBhcmFtIGNhbGxiYWNrIGEgc3luY2hyb25vdXMvYXN5bmNocm9ub3VzIHRlc3RcbiAqIEByZXR1cm4gZXZlbnR1YWxseSByZXR1cm5zIGEgbmV3IGFycmF5IHdpdGggb25seSB2YWx1ZXMgdGhhdCBoYXZlIHBhc3NlZFxuICovXG5leHBvcnQgZnVuY3Rpb24gZmlsdGVyPFQ+KGl0ZW1zOiAoVCB8IFByb21pc2U8VD4pW10sIGNhbGxiYWNrOiBGaWx0ZXJlcjxUPik6IFByb21pc2U8VFtdPiB7XG5cdHJldHVybiBwcm9jZXNzVmFsdWVzQW5kQ2FsbGJhY2soaXRlbXMsIGNhbGxiYWNrKS50aGVuPFRbXT4oZnVuY3Rpb24gKHsgcmVzdWx0cywgdmFsdWVzIH0pIHtcblx0XHRsZXQgYXJyOiBUW10gPSBbXTtcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdHMubGVuZ3RoOyBpKyspIHtcblx0XHRcdHJlc3VsdHNbaV0gJiYgYXJyLnB1c2godmFsdWVzW2ldKTtcblx0XHR9XG5cdFx0cmV0dXJuIGFycjtcblx0fSk7XG59XG5cbi8qKlxuICogRmluZCB0aGUgZmlyc3QgdmFsdWUgbWF0Y2hpbmcgYSBmaWx0ZXIgZnVuY3Rpb25cbiAqIEBwYXJhbSBpdGVtcyBhIGNvbGxlY3Rpb24gb2Ygc3luY2hyb25vdXMvYXN5bmNocm9ub3VzIHZhbHVlc1xuICogQHBhcmFtIGNhbGxiYWNrIGEgc3luY2hyb25vdXMvYXN5bmNocm9ub3VzIHRlc3RcbiAqIEByZXR1cm4gYSBwcm9taXNlIGV2ZW50dWFsbHkgY29udGFpbmluZyB0aGUgaXRlbSBvciB1bmRlZmluZWQgaWYgYSBtYXRjaCBpcyBub3QgZm91bmRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZpbmQ8VD4oaXRlbXM6IChUIHwgUHJvbWlzZTxUPilbXSwgY2FsbGJhY2s6IEZpbHRlcmVyPFQ+KTogUHJvbWlzZTxUPiB7XG5cdHJldHVybiBmaW5kSW5kZXg8VD4oaXRlbXMsIGNhbGxiYWNrKS50aGVuKGZ1bmN0aW9uIChpKSB7XG5cdFx0cmV0dXJuIGkgPj0gMCA/IGl0ZW1zW2ldIDogdW5kZWZpbmVkO1xuXHR9KTtcbn1cblxuLyoqXG4gKiBGaW5kIHRoZSBmaXJzdCBpbmRleCB3aXRoIGEgdmFsdWUgbWF0Y2hpbmcgdGhlIGZpbHRlciBmdW5jdGlvblxuICogQHBhcmFtIGl0ZW1zIGEgY29sbGVjdGlvbiBvZiBzeW5jaHJvbm91cy9hc3luY2hyb25vdXMgdmFsdWVzXG4gKiBAcGFyYW0gY2FsbGJhY2sgYSBzeW5jaHJvbm91cy9hc3luY2hyb25vdXMgdGVzdFxuICogQHJldHVybiBhIHByb21pc2UgZXZlbnR1YWxseSBjb250YWluaW5nIHRoZSBpbmRleCBvZiB0aGUgbWF0Y2hpbmcgaXRlbSBvciAtMSBpZiBhIG1hdGNoIGlzIG5vdCBmb3VuZFxuICovXG5leHBvcnQgZnVuY3Rpb24gZmluZEluZGV4PFQ+KGl0ZW1zOiAoVCB8IFByb21pc2U8VD4pW10sIGNhbGxiYWNrOiBGaWx0ZXJlcjxUPik6IFByb21pc2U8bnVtYmVyPiB7XG5cdC8vIFRPRE8gd2UgY2FuIGltcHJvdmUgdGhpcyBieSByZXR1cm5pbmcgaW1tZWRpYXRlbHlcblx0cmV0dXJuIHByb2Nlc3NWYWx1ZXNBbmRDYWxsYmFjayhpdGVtcywgY2FsbGJhY2spLnRoZW48bnVtYmVyPihmdW5jdGlvbiAoeyByZXN1bHRzIH0pIHtcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdHMubGVuZ3RoOyBpKyspIHtcblx0XHRcdGlmIChyZXN1bHRzW2ldKSB7XG5cdFx0XHRcdHJldHVybiBpO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRyZXR1cm4gLTE7XG5cdH0pO1xufVxuXG4vKipcbiAqIHRyYW5zZm9ybSBhIGxpc3Qgb2YgaXRlbXMgdXNpbmcgYSBtYXBwZXIgZnVuY3Rpb25cbiAqIEBwYXJhbSBpdGVtcyBhIGNvbGxlY3Rpb24gb2Ygc3luY2hyb25vdXMvYXN5bmNocm9ub3VzIHZhbHVlc1xuICogQHBhcmFtIGNhbGxiYWNrIGEgc3luY2hyb25vdXMvYXN5bmNocm9ub3VzIHRyYW5zZm9ybSBmdW5jdGlvblxuICogQHJldHVybiBhIHByb21pc2UgZXZlbnR1YWxseSBjb250YWluaW5nIGEgY29sbGVjdGlvbiBvZiBlYWNoIHRyYW5zZm9ybWVkIHZhbHVlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtYXA8VCwgVT4oaXRlbXM6IChUIHwgUHJvbWlzZTxUPilbXSwgY2FsbGJhY2s6IE1hcHBlcjxULCBVPik6IFByb21pc2U8VVtdPiB7XG5cdHJldHVybiBwcm9jZXNzVmFsdWVzQW5kQ2FsbGJhY2s8VCwgVT4oaXRlbXMsIGNhbGxiYWNrKVxuXHRcdFx0LnRoZW48VVtdPihmdW5jdGlvbiAoeyByZXN1bHRzIH0pIHtcblx0XHRcdFx0cmV0dXJuIHJlc3VsdHM7XG5cdFx0XHR9KTtcbn1cblxuLyoqXG4gKiByZWR1Y2UgYSBsaXN0IG9mIGl0ZW1zIGRvd24gdG8gYSBzaW5nbGUgdmFsdWVcbiAqIEBwYXJhbSBpdGVtcyBhIGNvbGxlY3Rpb24gb2Ygc3luY2hyb25vdXMvYXN5bmNocm9ub3VzIHZhbHVlc1xuICogQHBhcmFtIGNhbGxiYWNrIGEgc3luY2hyb25vdXMvYXN5bmNocm9ub3VzIHJlZHVjZXIgZnVuY3Rpb25cbiAqIEBwYXJhbSBbaW5pdGlhbFZhbHVlXSB0aGUgZmlyc3QgdmFsdWUgdG8gcGFzcyB0byB0aGUgY2FsbGJhY2tcbiAqIEByZXR1cm4gYSBwcm9taXNlIGV2ZW50dWFsbHkgY29udGFpbmluZyBhIHZhbHVlIHRoYXQgaXMgdGhlIHJlc3VsdCBvZiB0aGUgcmVkdWN0aW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWR1Y2U8VCwgVT4oaXRlbXM6IChUIHwgUHJvbWlzZTxUPilbXSwgY2FsbGJhY2s6IFJlZHVjZXI8VCwgVT4sIGluaXRpYWxWYWx1ZT86IFUpOiBQcm9taXNlPFU+IHtcblx0bGV0IGFyZ3M6IGFueVtdID0gPGFueVtdPiBhcnJheS5mcm9tKGFyZ3VtZW50cyk7XG5cdGFyZ3MudW5zaGlmdChmaW5kTmV4dFZhbHVlSW5kZXgpO1xuXHRyZXR1cm4gZ2VuZXJhbFJlZHVjZS5hcHBseSh0aGlzLCBhcmdzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlZHVjZVJpZ2h0PFQsIFU+KGl0ZW1zOiAoVCB8IFByb21pc2U8VD4pW10sIGNhbGxiYWNrOiBSZWR1Y2VyPFQsIFU+LCBpbml0aWFsVmFsdWU/OiBVKTogUHJvbWlzZTxVPiB7XG5cdGxldCBhcmdzOiBhbnlbXSA9IDxhbnlbXT4gYXJyYXkuZnJvbShhcmd1bWVudHMpO1xuXHRhcmdzLnVuc2hpZnQoZmluZExhc3RWYWx1ZUluZGV4KTtcblx0cmV0dXJuIGdlbmVyYWxSZWR1Y2UuYXBwbHkodGhpcywgYXJncyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJpZXM8VCwgVT4oaXRlbXM6IChUIHwgUHJvbWlzZTxUPilbXSwgb3BlcmF0aW9uOiBNYXBwZXI8VCwgVT4pOiBQcm9taXNlPFVbXT4ge1xuXHRyZXR1cm4gZ2VuZXJhbFJlZHVjZShmaW5kTmV4dFZhbHVlSW5kZXgsIGl0ZW1zLCBmdW5jdGlvbiAocHJldmlvdXNWYWx1ZSwgY3VycmVudFZhbHVlLCBpbmRleCwgYXJyYXkpIHtcblx0XHRjb25zdCByZXN1bHQgPSBvcGVyYXRpb24oY3VycmVudFZhbHVlLCBpbmRleCwgYXJyYXkpO1xuXG5cdFx0aWYgKCg8VGhlbmFibGU8VT4+IHJlc3VsdCkudGhlbikge1xuXHRcdFx0cmV0dXJuICg8VGhlbmFibGU8VT4+IHJlc3VsdCkudGhlbihmdW5jdGlvbiAodmFsdWUpIHtcblx0XHRcdFx0cHJldmlvdXNWYWx1ZS5wdXNoKHZhbHVlKTtcblx0XHRcdFx0cmV0dXJuIHByZXZpb3VzVmFsdWU7XG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRwcmV2aW91c1ZhbHVlLnB1c2gocmVzdWx0KTtcblx0XHRyZXR1cm4gcHJldmlvdXNWYWx1ZTtcblx0fSwgW10pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc29tZTxUPihpdGVtczogQXJyYXk8VCB8IFByb21pc2U8VD4+LCBjYWxsYmFjazogRmlsdGVyZXI8VD4pOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0cmV0dXJuIHRlc3RBbmRIYWx0T25Db25kaXRpb248VD4odHJ1ZSwgaXRlbXMsIGNhbGxiYWNrKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGaWx0ZXJlcjxUPiBleHRlbmRzIE1hcHBlcjxULCBib29sZWFuPiB7fVxuXG5leHBvcnQgaW50ZXJmYWNlIE1hcHBlcjxULCBVPiB7XG5cdCh2YWx1ZTogVCwgaW5kZXg6IG51bWJlciwgYXJyYXk6IFRbXSk6IChVIHwgVGhlbmFibGU8VT4pO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlZHVjZXI8VCwgVT4ge1xuXHQocHJldmlvdXNWYWx1ZTogVSwgY3VycmVudFZhbHVlOiBULCBpbmRleDogbnVtYmVyLCBhcnJheTogVFtdKTogKFUgfCBUaGVuYWJsZTxVPik7XG59XG4iXX0=