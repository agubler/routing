var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
(function (factory) {
    if (typeof module === 'object' && typeof module.exports === 'object') {
        var v = factory(require, exports); if (v !== undefined) module.exports = v;
    }
    else if (typeof define === 'function' && define.amd) {
        define(["require", "exports", '../Promise'], factory);
    }
})(function (require, exports) {
    "use strict";
    var Promise_1 = require('../Promise');
    exports.Canceled = 4;
    /**
     * A type guard that determines if `value` is a `Task`
     * @param value The value to guard
     */
    function isTask(value) {
        return Boolean(Promise_1.isThenable(value) && typeof value.cancel === 'function' && Array.isArray(value.children));
    }
    exports.isTask = isTask;
    /**
     * Task is an extension of Promise that supports cancelation.
     */
    var Task = (function (_super) {
        __extends(Task, _super);
        function Task(executor, canceler) {
            var _this = this;
            _super.call(this, function (resolve, reject) {
                // Don't let the Task resolve if it's been canceled
                executor(function (value) {
                    if (_this._state === exports.Canceled) {
                        return;
                    }
                    resolve(value);
                }, function (reason) {
                    if (_this._state === exports.Canceled) {
                        return;
                    }
                    reject(reason);
                });
            });
            this.children = [];
            this.canceler = function () {
                if (canceler) {
                    canceler();
                }
                _this._cancel();
            };
        }
        Task.all = function (items) {
            return _super.all.call(this, items);
        };
        Task.race = function (items) {
            return _super.race.call(this, items);
        };
        Task.reject = function (reason) {
            return _super.reject.call(this, reason);
        };
        Task.resolve = function (value) {
            return new this(function (resolve) {
                resolve(value);
            });
        };
        Task.copy = function (other) {
            var task = _super.copy.call(this, other);
            task.children = [];
            task.canceler = other instanceof Task ? other.canceler : function () { };
            return task;
        };
        /**
         * Propagates cancelation down through a Task tree. The Task's state is immediately set to canceled. If a Thenable
         * finally task was passed in, it is resolved before calling this Task's finally callback; otherwise, this Task's
         * finally callback is immediately executed. `_cancel` is called for each child Task, passing in the value returned
         * by this Task's finally callback or a Promise chain that will eventually resolve to that value.
         */
        Task.prototype._cancel = function (finallyTask) {
            var _this = this;
            this._state = exports.Canceled;
            var runFinally = function () {
                try {
                    return _this._finally();
                }
                catch (error) {
                }
            };
            if (this._finally) {
                if (Promise_1.isThenable(finallyTask)) {
                    finallyTask = finallyTask.then(runFinally, runFinally);
                }
                else {
                    finallyTask = runFinally();
                }
            }
            this.children.forEach(function (child) {
                child._cancel(finallyTask);
            });
        };
        /**
         * Immediately cancels this task if it has not already resolved. This Task and any descendants are synchronously set
         * to the Canceled state and any `finally` added downstream from the canceled Task are invoked.
         */
        Task.prototype.cancel = function () {
            if (this._state === Promise_1.State.Pending) {
                this.canceler();
            }
        };
        Task.prototype.finally = function (callback) {
            var task = _super.prototype.finally.call(this, callback);
            // Keep a reference to the callback; it will be called if the Task is canceled
            task._finally = callback;
            return task;
        };
        Task.prototype.then = function (onFulfilled, onRejected) {
            var _this = this;
            var task = _super.prototype.then.call(this, 
            // Don't call the onFulfilled or onRejected handlers if this Task is canceled
            function (value) {
                if (task._state === exports.Canceled) {
                    return;
                }
                if (onFulfilled) {
                    return onFulfilled(value);
                }
                return value;
            }, function (error) {
                if (task._state === exports.Canceled) {
                    return;
                }
                if (onRejected) {
                    return onRejected(error);
                }
                throw error;
            });
            task.canceler = function () {
                // If task's parent (this) hasn't been resolved, cancel it; downward propagation will start at the first
                // unresolved parent
                if (_this._state === Promise_1.State.Pending) {
                    _this.cancel();
                }
                else {
                    task._cancel();
                }
            };
            // Keep track of child Tasks for propogating cancelation back down the chain
            this.children.push(task);
            return task;
        };
        Task.prototype.catch = function (onRejected) {
            return _super.prototype.catch.call(this, onRejected);
        };
        return Task;
    }(Promise_1.default));
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = Task;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFzay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hc3luYy9UYXNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0lBQUEsd0JBQStELFlBQVksQ0FBQyxDQUFBO0lBRS9ELGdCQUFRLEdBQVcsQ0FBQyxDQUFDO0lBRWxDOzs7T0FHRztJQUNILGdCQUEwQixLQUFVO1FBQ25DLE1BQU0sQ0FBQyxPQUFPLENBQUMsb0JBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxPQUFPLEtBQUssQ0FBQyxNQUFNLEtBQUssVUFBVSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDMUcsQ0FBQztJQUZlLGNBQU0sU0FFckIsQ0FBQTtJQUVEOztPQUVHO0lBQ0g7UUFBcUMsd0JBQVU7UUE0QjlDLGNBQVksUUFBcUIsRUFBRSxRQUFxQjtZQTVCekQsaUJBcUtDO1lBeElDLGtCQUFNLFVBQUMsT0FBTyxFQUFFLE1BQU07Z0JBQ3JCLG1EQUFtRDtnQkFDbkQsUUFBUSxDQUNQLFVBQUMsS0FBSztvQkFDTCxFQUFFLENBQUMsQ0FBQyxLQUFJLENBQUMsTUFBTSxLQUFLLGdCQUFRLENBQUMsQ0FBQyxDQUFDO3dCQUM5QixNQUFNLENBQUM7b0JBQ1IsQ0FBQztvQkFDRCxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2hCLENBQUMsRUFDRCxVQUFDLE1BQU07b0JBQ04sRUFBRSxDQUFDLENBQUMsS0FBSSxDQUFDLE1BQU0sS0FBSyxnQkFBUSxDQUFDLENBQUMsQ0FBQzt3QkFDOUIsTUFBTSxDQUFDO29CQUNSLENBQUM7b0JBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNoQixDQUFDLENBQ0QsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7WUFDbkIsSUFBSSxDQUFDLFFBQVEsR0FBRztnQkFDZixFQUFF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QUM7UUFDdEMsQ0FBQztRQUVGLFdBQUM7SUFBRCxDQUFDLEFBcktELENBQXFDLGlCQUFPLEdBcUszQztJQXJLRDswQkFxS0MsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlLCB7IEV4ZWN1dG9yLCBTdGF0ZSwgVGhlbmFibGUsIGlzVGhlbmFibGUgfSBmcm9tICcuLi9Qcm9taXNlJztcblxuZXhwb3J0IGNvbnN0IENhbmNlbGVkID0gPFN0YXRlPiA0O1xuXG4vKipcbiAqIEEgdHlwZSBndWFyZCB0aGF0IGRldGVybWluZXMgaWYgYHZhbHVlYCBpcyBhIGBUYXNrYFxuICogQHBhcmFtIHZhbHVlIFRoZSB2YWx1ZSB0byBndWFyZFxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNUYXNrPFQ+KHZhbHVlOiBhbnkpOiB2YWx1ZSBpcyBUYXNrPFQ+IHtcblx0cmV0dXJuIEJvb2xlYW4oaXNUaGVuYWJsZSh2YWx1ZSkgJiYgdHlwZW9mIHZhbHVlLmNhbmNlbCA9PT0gJ2Z1bmN0aW9uJyAmJiBBcnJheS5pc0FycmF5KHZhbHVlLmNoaWxkcmVuKSk7XG59XG5cbi8qKlxuICogVGFzayBpcyBhbiBleHRlbnNpb24gb2YgUHJvbWlzZSB0aGF0IHN1cHBvcnRzIGNhbmNlbGF0aW9uLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUYXNrPFQ+IGV4dGVuZHMgUHJvbWlzZTxUPiB7XG5cdHN0YXRpYyBhbGw8VD4oaXRlbXM6IChUIHwgVGhlbmFibGU8VD4pW10pOiBUYXNrPFRbXT4ge1xuXHRcdHJldHVybiA8YW55PiBzdXBlci5hbGwoaXRlbXMpO1xuXHR9XG5cblx0c3RhdGljIHJhY2U8VD4oaXRlbXM6IChUIHwgVGhlbmFibGU8VD4pW10pOiBUYXNrPFQ+IHtcblx0XHRyZXR1cm4gPGFueT4gc3VwZXIucmFjZShpdGVtcyk7XG5cdH1cblxuXHRzdGF0aWMgcmVqZWN0PFQ+KHJlYXNvbjogRXJyb3IpOiBUYXNrPGFueT4ge1xuXHRcdHJldHVybiA8YW55PiBzdXBlci5yZWplY3QocmVhc29uKTtcblx0fVxuXG5cdHN0YXRpYyByZXNvbHZlKCk6IFRhc2s8dm9pZD47XG5cdHN0YXRpYyByZXNvbHZlPFQ+KHZhbHVlOiAoVCB8IFRoZW5hYmxlPFQ+KSk6IFRhc2s8VD47XG5cdHN0YXRpYyByZXNvbHZlPFQ+KHZhbHVlPzogYW55KTogVGFzazxUPiB7XG5cdFx0cmV0dXJuIG5ldyB0aGlzKChyZXNvbHZlKSA9PiB7XG5cdFx0XHRyZXNvbHZlKHZhbHVlKTtcblx0XHR9KTtcblx0fVxuXG5cdHByb3RlY3RlZCBzdGF0aWMgY29weTxVPihvdGhlcjogUHJvbWlzZTxVPik6IFRhc2s8VT4ge1xuXHRcdGNvbnN0IHRhc2sgPSA8VGFzazxVPj4gc3VwZXIuY29weShvdGhlcik7XG5cdFx0dGFzay5jaGlsZHJlbiA9IFtdO1xuXHRcdHRhc2suY2FuY2VsZXIgPSBvdGhlciBpbnN0YW5jZW9mIFRhc2sgPyBvdGhlci5jYW5jZWxlciA6IGZ1bmN0aW9uICgpIHt9O1xuXHRcdHJldHVybiB0YXNrO1xuXHR9XG5cblx0Y29uc3RydWN0b3IoZXhlY3V0b3I6IEV4ZWN1dG9yPFQ+LCBjYW5jZWxlcj86ICgpID0+IHZvaWQpIHtcblx0XHRzdXBlcigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdFx0XHQvLyBEb24ndCBsZXQgdGhlIFRhc2sgcmVzb2x2ZSBpZiBpdCdzIGJlZW4gY2FuY2VsZWRcblx0XHRcdGV4ZWN1dG9yKFxuXHRcdFx0XHQodmFsdWUpID0+IHtcblx0XHRcdFx0XHRpZiAodGhpcy5fc3RhdGUgPT09IENhbmNlbGVkKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdHJlc29sdmUodmFsdWUpO1xuXHRcdFx0XHR9LFxuXHRcdFx0XHQocmVhc29uKSA9PiB7XG5cdFx0XHRcdFx0aWYgKHRoaXMuX3N0YXRlID09PSBDYW5jZWxlZCkge1xuXHRcdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRyZWplY3QocmVhc29uKTtcblx0XHRcdFx0fVxuXHRcdFx0KTtcblx0XHR9KTtcblxuXHRcdHRoaXMuY2hpbGRyZW4gPSBbXTtcblx0XHR0aGlzLmNhbmNlbGVyID0gKCkgPT4ge1xuXHRcdFx0aWYgKGNhbmNlbGVyKSB7XG5cdFx0XHRcdGNhbmNlbGVyKCk7XG5cdFx0XHR9XG5cdFx0XHR0aGlzLl9jYW5jZWwoKTtcblx0XHR9O1xuXHR9XG5cblx0LyoqXG5cdCAqIEEgY2FuY2VsYXRpb24gaGFuZGxlciB0aGF0IHdpbGwgYmUgY2FsbGVkIGlmIHRoaXMgdGFzayBpcyBjYW5jZWxlZC5cblx0ICovXG5cdHByaXZhdGUgY2FuY2VsZXI6ICgpID0+IHZvaWQ7XG5cblx0LyoqXG5cdCAqIENoaWxkcmVuIG9mIHRoaXMgVGFzayAoaS5lLiwgVGFza3MgdGhhdCB3ZXJlIGNyZWF0ZWQgZnJvbSB0aGlzIFRhc2sgd2l0aCBgdGhlbmAgb3IgYGNhdGNoYCkuXG5cdCAqL1xuXHRwcml2YXRlIGNoaWxkcmVuOiBUYXNrPGFueT5bXTtcblxuXHQvKipcblx0ICogVGhlIGZpbmFsbHkgY2FsbGJhY2sgZm9yIHRoaXMgVGFzayAoaWYgaXQgd2FzIGNyZWF0ZWQgYnkgYSBjYWxsIHRvIGBmaW5hbGx5YCkuXG5cdCAqL1xuXHRwcml2YXRlIF9maW5hbGx5OiAoKSA9PiB2b2lkIHwgVGhlbmFibGU8YW55PjtcblxuXHQvKipcblx0ICogUHJvcGFnYXRlcyBjYW5jZWxhdGlvbiBkb3duIHRocm91Z2ggYSBUYXNrIHRyZWUuIFRoZSBUYXNrJ3Mgc3RhdGUgaXMgaW1tZWRpYXRlbHkgc2V0IHRvIGNhbmNlbGVkLiBJZiBhIFRoZW5hYmxlXG5cdCAqIGZpbmFsbHkgdGFzayB3YXMgcGFzc2VkIGluLCBpdCBpcyByZXNvbHZlZCBiZWZvcmUgY2FsbGluZyB0aGlzIFRhc2sncyBmaW5hbGx5IGNhbGxiYWNrOyBvdGhlcndpc2UsIHRoaXMgVGFzaydzXG5cdCAqIGZpbmFsbHkgY2FsbGJhY2sgaXMgaW1tZWRpYXRlbHkgZXhlY3V0ZWQuIGBfY2FuY2VsYCBpcyBjYWxsZWQgZm9yIGVhY2ggY2hpbGQgVGFzaywgcGFzc2luZyBpbiB0aGUgdmFsdWUgcmV0dXJuZWRcblx0ICogYnkgdGhpcyBUYXNrJ3MgZmluYWxseSBjYWxsYmFjayBvciBhIFByb21pc2UgY2hhaW4gdGhhdCB3aWxsIGV2ZW50dWFsbHkgcmVzb2x2ZSB0byB0aGF0IHZhbHVlLlxuXHQgKi9cblx0cHJpdmF0ZSBfY2FuY2VsKGZpbmFsbHlUYXNrPzogdm9pZCB8IFRoZW5hYmxlPGFueT4pOiB2b2lkIHtcblx0XHR0aGlzLl9zdGF0ZSA9IENhbmNlbGVkO1xuXG5cdFx0Y29uc3QgcnVuRmluYWxseSA9ICgpID0+IHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdHJldHVybiB0aGlzLl9maW5hbGx5KCk7XG5cdFx0XHR9XG5cdFx0XHRjYXRjaCAoZXJyb3IpIHtcblx0XHRcdFx0Ly8gQW55IGVycm9ycyBpbiBhIGBmaW5hbGx5YCBjYWxsYmFjayBhcmUgY29tcGxldGVseSBpZ25vcmVkIGR1cmluZyBjYW5jZWxhdGlvblxuXHRcdFx0fVxuXHRcdH07XG5cblx0XHRpZiAodGhpcy5fZmluYWxseSkge1xuXHRcdFx0aWYgKGlzVGhlbmFibGUoZmluYWxseVRhc2spKSB7XG5cdFx0XHRcdGZpbmFsbHlUYXNrID0gKDxUaGVuYWJsZTxhbnk+PiBmaW5hbGx5VGFzaykudGhlbihydW5GaW5hbGx5LCBydW5GaW5hbGx5KTtcblx0XHRcdH1cblx0XHRcdGVsc2Uge1xuXHRcdFx0XHRmaW5hbGx5VGFzayA9IHJ1bkZpbmFsbHkoKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHR0aGlzLmNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7XG5cdFx0XHRjaGlsZC5fY2FuY2VsKGZpbmFsbHlUYXNrKTtcblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBJbW1lZGlhdGVseSBjYW5jZWxzIHRoaXMgdGFzayBpZiBpdCBoYXMgbm90IGFscmVhZHkgcmVzb2x2ZWQuIFRoaXMgVGFzayBhbmQgYW55IGRlc2NlbmRhbnRzIGFyZSBzeW5jaHJvbm91c2x5IHNldFxuXHQgKiB0byB0aGUgQ2FuY2VsZWQgc3RhdGUgYW5kIGFueSBgZmluYWxseWAgYWRkZWQgZG93bnN0cmVhbSBmcm9tIHRoZSBjYW5jZWxlZCBUYXNrIGFyZSBpbnZva2VkLlxuXHQgKi9cblx0Y2FuY2VsKCk6IHZvaWQge1xuXHRcdGlmICh0aGlzLl9zdGF0ZSA9PT0gU3RhdGUuUGVuZGluZykge1xuXHRcdFx0dGhpcy5jYW5jZWxlcigpO1xuXHRcdH1cblx0fVxuXG5cdGZpbmFsbHkoY2FsbGJhY2s6ICgpID0+IHZvaWQgfCBUaGVuYWJsZTxhbnk+KTogVGFzazxUPiB7XG5cdFx0Y29uc3QgdGFzayA9IDxUYXNrPFQ+PiBzdXBlci5maW5hbGx5KGNhbGxiYWNrKTtcblx0XHQvLyBLZWVwIGEgcmVmZXJlbmNlIHRvIHRoZSBjYWxsYmFjazsgaXQgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIFRhc2sgaXMgY2FuY2VsZWRcblx0XHR0YXNrLl9maW5hbGx5ID0gY2FsbGJhY2s7XG5cdFx0cmV0dXJuIHRhc2s7XG5cdH1cblxuXHR0aGVuPFU+KG9uRnVsZmlsbGVkPzogKHZhbHVlOiBUKSA9PiBVIHwgVGhlbmFibGU8VT4sICBvblJlamVjdGVkPzogKGVycm9yOiBFcnJvcikgPT4gVSB8IFRoZW5hYmxlPFU+KTogVGFzazxVPiB7XG5cdFx0Y29uc3QgdGFzayA9IDxUYXNrPFU+PiBzdXBlci50aGVuPFU+KFxuXHRcdFx0Ly8gRG9uJ3QgY2FsbCB0aGUgb25GdWxmaWxsZWQgb3Igb25SZWplY3RlZCBoYW5kbGVycyBpZiB0aGlzIFRhc2sgaXMgY2FuY2VsZWRcblx0XHRcdGZ1bmN0aW9uICh2YWx1ZSkge1xuXHRcdFx0XHRpZiAodGFzay5fc3RhdGUgPT09IENhbmNlbGVkKSB7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmIChvbkZ1bGZpbGxlZCkge1xuXHRcdFx0XHRcdHJldHVybiBvbkZ1bGZpbGxlZCh2YWx1ZSk7XG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuIDxhbnk+IHZhbHVlO1xuXHRcdFx0fSxcblx0XHRcdGZ1bmN0aW9uIChlcnJvcikge1xuXHRcdFx0XHRpZiAodGFzay5fc3RhdGUgPT09IENhbmNlbGVkKSB7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmIChvblJlamVjdGVkKSB7XG5cdFx0XHRcdFx0cmV0dXJuIG9uUmVqZWN0ZWQoZXJyb3IpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHRocm93IGVycm9yO1xuXHRcdFx0fVxuXHRcdCk7XG5cblx0XHR0YXNrLmNhbmNlbGVyID0gKCkgPT4ge1xuXHRcdFx0Ly8gSWYgdGFzaydzIHBhcmVudCAodGhpcykgaGFzbid0IGJlZW4gcmVzb2x2ZWQsIGNhbmNlbCBpdDsgZG93bndhcmQgcHJvcGFnYXRpb24gd2lsbCBzdGFydCBhdCB0aGUgZmlyc3Rcblx0XHRcdC8vIHVucmVzb2x2ZWQgcGFyZW50XG5cdFx0XHRpZiAodGhpcy5fc3RhdGUgPT09IFN0YXRlLlBlbmRpbmcpIHtcblx0XHRcdFx0dGhpcy5jYW5jZWwoKTtcblx0XHRcdH1cblx0XHRcdC8vIElmIHRhc2sncyBwYXJlbnQgaGFzIGJlZW4gcmVzb2x2ZWQsIHByb3BhZ2F0ZSBjYW5jZWxhdGlvbiB0byB0aGUgdGFzaydzIGRlc2NlbmRhbnRzXG5cdFx0XHRlbHNlIHtcblx0XHRcdFx0dGFzay5fY2FuY2VsKCk7XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdC8vIEtlZXAgdHJhY2sgb2YgY2hpbGQgVGFza3MgZm9yIHByb3BvZ2F0aW5nIGNhbmNlbGF0aW9uIGJhY2sgZG93biB0aGUgY2hhaW5cblx0XHR0aGlzLmNoaWxkcmVuLnB1c2godGFzayk7XG5cblx0XHRyZXR1cm4gdGFzaztcblx0fVxuXG5cdGNhdGNoPFU+KG9uUmVqZWN0ZWQ6IChyZWFzb24/OiBFcnJvcikgPT4gKFUgfCBUaGVuYWJsZTxVPikpOiBUYXNrPFU+IHtcblx0XHRyZXR1cm4gPGFueT4gc3VwZXIuY2F0Y2gob25SZWplY3RlZCk7XG5cdH1cblxufVxuIl19