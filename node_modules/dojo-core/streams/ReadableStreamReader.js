(function (factory) {
    if (typeof module === 'object' && typeof module.exports === 'object') {
        var v = factory(require, exports); if (v !== undefined) module.exports = v;
    }
    else if (typeof define === 'function' && define.amd) {
        define(["require", "exports", '../Promise', './ReadableStream'], factory);
    }
})(function (require, exports) {
    "use strict";
    var Promise_1 = require('../Promise');
    var ReadableStream_1 = require('./ReadableStream');
    function isReadableStreamReader(readableStreamReader) {
        return Object.prototype.hasOwnProperty.call(readableStreamReader, '_ownerReadableStream');
    }
    /**
     * This class provides the interface for reading data from a stream. A reader can by acquired by calling
     * {@link ReadableStream#getReader}. A {@link ReadableStream} can only have a single reader at any time. A reader can
     * be released from the stream by calling {@link ReadableStreamReader.releaseLock}. If the stream still has data, a new
     * reader can be acquired to read from the stream.
     */
    var ReadableStreamReader = (function () {
        function ReadableStreamReader(stream) {
            var _this = this;
            if (!stream.readable) {
                throw new TypeError('3.4.3-1: stream must be a ReadableStream');
            }
            if (stream.locked) {
                throw new TypeError('3.4.3-2: stream cannot be locked');
            }
            stream.reader = this;
            this._ownerReadableStream = stream;
            this.state = ReadableStream_1.State.Readable;
            this._storedError = undefined;
            this._readRequests = [];
            this._closedPromise = new Promise_1.default(function (resolve, reject) {
                _this._resolveClosedPromise = resolve;
                _this._rejectClosedPromise = reject;
            });
        }
        Object.defineProperty(ReadableStreamReader.prototype, "closed", {
            get: function () {
                return this._closedPromise;
            },
            enumerable: true,
            configurable: true
        });
        /**
         * Cancel a stream. The reader is released and the stream is closed. {@link ReadableStream.Source#cancel} is
         * called with the provided `reason`.
         *
         * @param reason The reason for canceling the stream
         */
        ReadableStreamReader.prototype.cancel = function (reason) {
            if (!isReadableStreamReader(this)) {
                return Promise_1.default.reject(new TypeError('3.4.4.2-1: Must be a ReadableStreamReader instance'));
            }
            if (this.state === ReadableStream_1.State.Closed) {
                return Promise_1.default.resolve();
            }
            if (this.state === ReadableStream_1.State.Errored) {
                return Promise_1.default.reject(this._storedError);
            }
            if (this._ownerReadableStream && this._ownerReadableStream.state === ReadableStream_1.State.Readable) {
                return this._ownerReadableStream.cancel(reason);
            }
            // 3.4.4.2-4,5 - the spec calls for this to throw an error. We have changed it to reject instead
            return Promise_1.default.reject(new TypeError('3.4.4.2-4,5: Cannot cancel ReadableStreamReader'));
        };
        /**
         * Read data from the stream.
         *
         * @returns A promise that resolves to a {@link ReadResult}.
         */
        // This method also incorporates the ReadFromReadableStreamReader from 3.5.12.
        ReadableStreamReader.prototype.read = function () {
            var _this = this;
            if (!isReadableStreamReader(this)) {
                return Promise_1.default.reject(new TypeError('3.4.4.3-1: Must be a ReadableStreamReader instance'));
            }
            if (this.state === ReadableStream_1.State.Closed) {
                return Promise_1.default.resolve({
                    value: undefined,
                    done: true
                });
            }
            if (this.state === ReadableStream_1.State.Errored) {
                return Promise_1.default.reject(new TypeError('3.5.12-2: reader state is Errored'));
            }
            var stream = this._ownerReadableStream;
            if (!stream || stream.state !== ReadableStream_1.State.Readable) {
                throw new TypeError('3.5.12-3,4: Stream must exist and be readable');
            }
            var queue = stream.queue;
            if (queue.length > 0) {
                var chunk = queue.dequeue();
                if (stream.closeRequested && !queue.length) {
                    stream.close();
                }
                else {
                    stream.pull();
                }
                return Promise_1.default.resolve({
                    value: chunk,
                    done: false
                });
            }
            else {
                var readPromise_1 = new Promise_1.default(function (resolve, reject) {
                    _this._readRequests.push({
                        promise: readPromise_1,
                        resolve: resolve,
                        reject: reject
                    });
                    stream.pull();
                });
                return readPromise_1;
            }
        };
        /**
         * Release a reader's lock on the corresponding stream. The reader will no longer be readable. Further reading on
         * the stream can be done by acquiring a new `ReadableStreamReader`.
         */
        // 3.4.4.4. releaseLock()
        ReadableStreamReader.prototype.releaseLock = function () {
            if (!isReadableStreamReader(this)) {
                throw new TypeError('3.4.4.4-1: Must be a ReadableStreamReader isntance');
            }
            if (!this._ownerReadableStream) {
                return;
            }
            if (this._readRequests.length) {
                throw new TypeError('3.4.4.4-3: Tried to release a reader lock when that reader has pending read calls un-settled');
            }
            this.release();
        };
        // 3.5.13. ReleaseReadableStreamReader ( reader )
        ReadableStreamReader.prototype.release = function () {
            var request;
            if (this._ownerReadableStream.state === ReadableStream_1.State.Errored) {
                this.state = ReadableStream_1.State.Errored;
                var e = this._ownerReadableStream.storedError;
                this._storedError = e;
                this._rejectClosedPromise(e);
                for (var _i = 0, _a = this._readRequests; _i < _a.length; _i++) {
                    request = _a[_i];
                    request.reject(e);
                }
            }
            else {
                this.state = ReadableStream_1.State.Closed;
                this._resolveClosedPromise();
                for (var _b = 0, _c = this._readRequests; _b < _c.length; _b++) {
                    request = _c[_b];
                    request.resolve({
                        value: undefined,
                        done: true
                    });
                }
            }
            this._readRequests = [];
            this._ownerReadableStream.reader = undefined;
            this._ownerReadableStream = undefined;
        };
        /**
         * Resolves a pending read request, if any, with the provided chunk.
         * @param chunk
         * @return boolean True if a read request was resolved.
         */
        ReadableStreamReader.prototype.resolveReadRequest = function (chunk) {
            if (this._readRequests.length > 0) {
                this._readRequests.shift().resolve({
                    value: chunk,
                    done: false
                });
                return true;
            }
            return false;
        };
        return ReadableStreamReader;
    }());
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = ReadableStreamReader;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVhZGFibGVTdHJlYW1SZWFkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RyZWFtcy9SZWFkYWJsZVN0cmVhbVJlYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7SUFBQSx3QkFBb0IsWUFBWSxDQUFDLENBQUE7SUFDakMsK0JBQXNDLGtCQUFrQixDQUFDLENBQUE7SUFpQnpELGdDQUFtQyxvQkFBNkM7UUFDL0UsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0lBQzNGLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNIO1FBZUMsOEJBQVksTUFBeUI7WUFmdEMsaUJBdUxDO1lBdktDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLE1BQU0sSUFBSSxTQUFTLENBQUMsMENBQTBDLENBQUMsQ0FBQztZQUNqRSxDQUFDO1lBRUQsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ25CLE1BQU0sSUFBSSxTQUFTLENBQUMsa0NBQWtDLENBQUMsQ0FBQztZQUN6RCxDQUFDO1lBRUQsTUFBTSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7WUFDckIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLE1BQU0sQ0FBQztZQUNuQyxJQUFJLENBQUMsS0FBSyxHQUFHLHNCQUFLLENBQUMsUUFBUSxDQUFDO1lBQzVCLElBQUksQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDO1lBQzlCLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxpQkFBTyxDQUFPLFVBQUMsT0FBTyxFQUFFLE1BQU07Z0JBQ3ZELEtBQUksQ0FBQyxxQkFBcUIsR0FBRyxPQUFPLENBQUM7Z0JBQ3JDLEtBQUksQ0FBQyxv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QkFBb0IsR0FBRyxTQUFTLENBQUM7UUFDdkMsQ0FBQztRQUVEOzs7O1dBSUc7UUFDSCxpREFBa0IsR0FBbEIsVUFBbUIsS0FBUTtZQUMxQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNuQyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDLE9BQU8sQ0FBQztvQkFDbEMsS0FBSyxFQUFFLEtBQUs7b0JBQ1osSUFBSSxFQUFFLEtBQUs7aUJBQ1gsQ0FBQyxDQUFDO2dCQUNILE1BQU0sQ0FBQyxJQUFJLENBQUM7WUFDYixDQUFDO1lBQ0QsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNkLENBQUM7UUFDRiwyQkFBQztJQUFELENBQUMsQUF2TEQsSUF1TEM7SUF2TEQ7MENBdUxDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvbWlzZSBmcm9tICcuLi9Qcm9taXNlJztcbmltcG9ydCBSZWFkYWJsZVN0cmVhbSwgeyBTdGF0ZSB9IGZyb20gJy4vUmVhZGFibGVTdHJlYW0nO1xuXG5pbnRlcmZhY2UgUmVhZFJlcXVlc3Q8VD4ge1xuXHRwcm9taXNlOiBQcm9taXNlPFJlYWRSZXN1bHQ8VD4+O1xuXHRyZXNvbHZlOiAodmFsdWU6IFJlYWRSZXN1bHQ8VD4pID0+IHZvaWQ7XG5cdHJlamVjdDogKHJlYXNvbjogYW55KSA9PiB2b2lkO1xufVxuXG4vKipcbiAqIFJlcHJlc2VudHMgdGhlIG9iamVjdHMgcmV0dXJuZWQgYnkge0BsaW5rIFJlYWRhYmxlU3RyZWFtUmVhZGVyI3JlYWR9LiBUaGUgZGF0YSBpcyBhY2Nlc3NpYmxlIG9uIHRoZSBgdmFsdWVgIHByb3BlcnR5LlxuICogSWYgdGhlIGBkb25lYCBwcm9wZXJ0eSBpcyB0cnVlLCB0aGUgc3RyZWFtIGhhcyBubyBtb3JlIGRhdGEgdG8gcHJvdmlkZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWFkUmVzdWx0PFQ+IHtcblx0dmFsdWU6IFQ7XG5cdGRvbmU6IGJvb2xlYW47XG59XG5cbmZ1bmN0aW9uIGlzUmVhZGFibGVTdHJlYW1SZWFkZXI8VD4ocmVhZGFibGVTdHJlYW1SZWFkZXI6IFJlYWRhYmxlU3RyZWFtUmVhZGVyPFQ+KTogYm9vbGVhbiB7XG5cdHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocmVhZGFibGVTdHJlYW1SZWFkZXIsICdfb3duZXJSZWFkYWJsZVN0cmVhbScpO1xufVxuXG4vKipcbiAqIFRoaXMgY2xhc3MgcHJvdmlkZXMgdGhlIGludGVyZmFjZSBmb3IgcmVhZGluZyBkYXRhIGZyb20gYSBzdHJlYW0uIEEgcmVhZGVyIGNhbiBieSBhY3F1aXJlZCBieSBjYWxsaW5nXG4gKiB7QGxpbmsgUmVhZGFibGVTdHJlYW0jZ2V0UmVhZGVyfS4gQSB7QGxpbmsgUmVhZGFibGVTdHJlYW19IGNhbiBvbmx5IGhhdmUgYSBzaW5nbGUgcmVhZGVyIGF0IGFueSB0aW1lLiBBIHJlYWRlciBjYW5cbiAqIGJlIHJlbGVhc2VkIGZyb20gdGhlIHN0cmVhbSBieSBjYWxsaW5nIHtAbGluayBSZWFkYWJsZVN0cmVhbVJlYWRlci5yZWxlYXNlTG9ja30uIElmIHRoZSBzdHJlYW0gc3RpbGwgaGFzIGRhdGEsIGEgbmV3XG4gKiByZWFkZXIgY2FuIGJlIGFjcXVpcmVkIHRvIHJlYWQgZnJvbSB0aGUgc3RyZWFtLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZWFkYWJsZVN0cmVhbVJlYWRlcjxUPiB7XG5cdGdldCBjbG9zZWQoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0cmV0dXJuIHRoaXMuX2Nsb3NlZFByb21pc2U7XG5cdH1cblxuXHRwcml2YXRlIF9jbG9zZWRQcm9taXNlOiBQcm9taXNlPHZvaWQ+O1xuXHRwcml2YXRlIF9zdG9yZWRFcnJvcjogRXJyb3I7XG5cdHByaXZhdGUgX3JlYWRSZXF1ZXN0czogUmVhZFJlcXVlc3Q8VD5bXTtcblx0cHJpdmF0ZSBfcmVzb2x2ZUNsb3NlZFByb21pc2U6ICgpID0+IHZvaWQ7XG5cdHByaXZhdGUgX3JlamVjdENsb3NlZFByb21pc2U6IChlcnJvcjogRXJyb3IpID0+IHZvaWQ7XG5cblx0cHJvdGVjdGVkIF9vd25lclJlYWRhYmxlU3RyZWFtOiBSZWFkYWJsZVN0cmVhbTxUPjtcblxuXHRzdGF0ZTogU3RhdGU7XG5cblx0Y29uc3RydWN0b3Ioc3RyZWFtOiBSZWFkYWJsZVN0cmVhbTxUPikge1xuXHRcdGlmICghc3RyZWFtLnJlYWRhYmxlKSB7XG5cdFx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKCczLjQuMy0xOiBzdHJlYW0gbXVzdCBiZSBhIFJlYWRhYmxlU3RyZWFtJyk7XG5cdFx0fVxuXG5cdFx0aWYgKHN0cmVhbS5sb2NrZWQpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoJzMuNC4zLTI6IHN0cmVhbSBjYW5ub3QgYmUgbG9ja2VkJyk7XG5cdFx0fVxuXG5cdFx0c3RyZWFtLnJlYWRlciA9IHRoaXM7XG5cdFx0dGhpcy5fb3duZXJSZWFkYWJsZVN0cmVhbSA9IHN0cmVhbTtcblx0XHR0aGlzLnN0YXRlID0gU3RhdGUuUmVhZGFibGU7XG5cdFx0dGhpcy5fc3RvcmVkRXJyb3IgPSB1bmRlZmluZWQ7XG5cdFx0dGhpcy5fcmVhZFJlcXVlc3RzID0gW107XG5cdFx0dGhpcy5fY2xvc2VkUHJvbWlzZSA9IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdHRoaXMuX3Jlc29sdmVDbG9zZWRQcm9taXNlID0gcmVzb2x2ZTtcblx0XHRcdHRoaXMuX3JlamVjdENsb3NlZFByb21pc2UgPSByZWplY3Q7XG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogQ2FuY2VsIGEgc3RyZWFtLiBUaGUgcmVhZGVyIGlzIHJlbGVhc2VkIGFuZCB0aGUgc3RyZWFtIGlzIGNsb3NlZC4ge0BsaW5rIFJlYWRhYmxlU3RyZWFtLlNvdXJjZSNjYW5jZWx9IGlzXG5cdCAqIGNhbGxlZCB3aXRoIHRoZSBwcm92aWRlZCBgcmVhc29uYC5cblx0ICpcblx0ICogQHBhcmFtIHJlYXNvbiBUaGUgcmVhc29uIGZvciBjYW5jZWxpbmcgdGhlIHN0cmVhbVxuXHQgKi9cblx0Y2FuY2VsKHJlYXNvbjogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0aWYgKCFpc1JlYWRhYmxlU3RyZWFtUmVhZGVyKHRoaXMpKSB7XG5cdFx0XHRyZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFR5cGVFcnJvcignMy40LjQuMi0xOiBNdXN0IGJlIGEgUmVhZGFibGVTdHJlYW1SZWFkZXIgaW5zdGFuY2UnKSk7XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuc3RhdGUgPT09IFN0YXRlLkNsb3NlZCkge1xuXHRcdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLnN0YXRlID09PSBTdGF0ZS5FcnJvcmVkKSB7XG5cdFx0XHRyZXR1cm4gUHJvbWlzZS5yZWplY3QodGhpcy5fc3RvcmVkRXJyb3IpO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLl9vd25lclJlYWRhYmxlU3RyZWFtICYmIHRoaXMuX293bmVyUmVhZGFibGVTdHJlYW0uc3RhdGUgPT09IFN0YXRlLlJlYWRhYmxlKSB7XG5cdFx0XHRyZXR1cm4gdGhpcy5fb3duZXJSZWFkYWJsZVN0cmVhbS5jYW5jZWwocmVhc29uKTtcblx0XHR9XG5cblx0XHQvLyAzLjQuNC4yLTQsNSAtIHRoZSBzcGVjIGNhbGxzIGZvciB0aGlzIHRvIHRocm93IGFuIGVycm9yLiBXZSBoYXZlIGNoYW5nZWQgaXQgdG8gcmVqZWN0IGluc3RlYWRcblx0XHRyZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFR5cGVFcnJvcignMy40LjQuMi00LDU6IENhbm5vdCBjYW5jZWwgUmVhZGFibGVTdHJlYW1SZWFkZXInKSk7XG5cdH1cblxuXHQvKipcblx0ICogUmVhZCBkYXRhIGZyb20gdGhlIHN0cmVhbS5cblx0ICpcblx0ICogQHJldHVybnMgQSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gYSB7QGxpbmsgUmVhZFJlc3VsdH0uXG5cdCAqL1xuXHQvLyBUaGlzIG1ldGhvZCBhbHNvIGluY29ycG9yYXRlcyB0aGUgUmVhZEZyb21SZWFkYWJsZVN0cmVhbVJlYWRlciBmcm9tIDMuNS4xMi5cblx0cmVhZCgpOiBQcm9taXNlPFJlYWRSZXN1bHQ8VD4+IHtcblx0XHRpZiAoIWlzUmVhZGFibGVTdHJlYW1SZWFkZXIodGhpcykpIHtcblx0XHRcdHJldHVybiBQcm9taXNlLnJlamVjdDxSZWFkUmVzdWx0PFQ+PihuZXcgVHlwZUVycm9yKCczLjQuNC4zLTE6IE11c3QgYmUgYSBSZWFkYWJsZVN0cmVhbVJlYWRlciBpbnN0YW5jZScpKTtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5zdGF0ZSA9PT0gU3RhdGUuQ2xvc2VkKSB7XG5cdFx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcblx0XHRcdFx0dmFsdWU6IHVuZGVmaW5lZCxcblx0XHRcdFx0ZG9uZTogdHJ1ZVxuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuc3RhdGUgPT09IFN0YXRlLkVycm9yZWQpIHtcblx0XHRcdHJldHVybiBQcm9taXNlLnJlamVjdDxSZWFkUmVzdWx0PFQ+PihuZXcgVHlwZUVycm9yKCczLjUuMTItMjogcmVhZGVyIHN0YXRlIGlzIEVycm9yZWQnKSk7XG5cdFx0fVxuXG5cdFx0Y29uc3Qgc3RyZWFtID0gdGhpcy5fb3duZXJSZWFkYWJsZVN0cmVhbTtcblx0XHRpZiAoIXN0cmVhbSB8fCBzdHJlYW0uc3RhdGUgIT09IFN0YXRlLlJlYWRhYmxlKSB7XG5cdFx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKCczLjUuMTItMyw0OiBTdHJlYW0gbXVzdCBleGlzdCBhbmQgYmUgcmVhZGFibGUnKTtcblx0XHR9XG5cblx0XHRjb25zdCBxdWV1ZSA9IHN0cmVhbS5xdWV1ZTtcblx0XHRpZiAocXVldWUubGVuZ3RoID4gMCkge1xuXHRcdFx0Y29uc3QgY2h1bmsgPSBxdWV1ZS5kZXF1ZXVlKCk7XG5cdFx0XHRpZiAoc3RyZWFtLmNsb3NlUmVxdWVzdGVkICYmICFxdWV1ZS5sZW5ndGgpIHtcblx0XHRcdFx0c3RyZWFtLmNsb3NlKCk7XG5cdFx0XHR9XG5cdFx0XHRlbHNlIHtcblx0XHRcdFx0c3RyZWFtLnB1bGwoKTtcblx0XHRcdH1cblx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuXHRcdFx0XHR2YWx1ZTogY2h1bmssXG5cdFx0XHRcdGRvbmU6IGZhbHNlXG5cdFx0XHR9KTtcblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHRjb25zdCByZWFkUHJvbWlzZSA9IG5ldyBQcm9taXNlPFJlYWRSZXN1bHQ8VD4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdFx0dGhpcy5fcmVhZFJlcXVlc3RzLnB1c2goe1xuXHRcdFx0XHRcdHByb21pc2U6IHJlYWRQcm9taXNlLFxuXHRcdFx0XHRcdHJlc29sdmU6IHJlc29sdmUsXG5cdFx0XHRcdFx0cmVqZWN0OiByZWplY3Rcblx0XHRcdFx0fSk7XG5cdFx0XHRcdHN0cmVhbS5wdWxsKCk7XG5cdFx0XHR9KTtcblxuXHRcdFx0cmV0dXJuIHJlYWRQcm9taXNlO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBSZWxlYXNlIGEgcmVhZGVyJ3MgbG9jayBvbiB0aGUgY29ycmVzcG9uZGluZyBzdHJlYW0uIFRoZSByZWFkZXIgd2lsbCBubyBsb25nZXIgYmUgcmVhZGFibGUuIEZ1cnRoZXIgcmVhZGluZyBvblxuXHQgKiB0aGUgc3RyZWFtIGNhbiBiZSBkb25lIGJ5IGFjcXVpcmluZyBhIG5ldyBgUmVhZGFibGVTdHJlYW1SZWFkZXJgLlxuXHQgKi9cblx0Ly8gMy40LjQuNC4gcmVsZWFzZUxvY2soKVxuXHRyZWxlYXNlTG9jaygpOiB2b2lkIHtcblx0XHRpZiAoIWlzUmVhZGFibGVTdHJlYW1SZWFkZXIodGhpcykpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoJzMuNC40LjQtMTogTXVzdCBiZSBhIFJlYWRhYmxlU3RyZWFtUmVhZGVyIGlzbnRhbmNlJyk7XG5cdFx0fVxuXG5cdFx0aWYgKCF0aGlzLl9vd25lclJlYWRhYmxlU3RyZWFtKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuX3JlYWRSZXF1ZXN0cy5sZW5ndGgpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoJzMuNC40LjQtMzogVHJpZWQgdG8gcmVsZWFzZSBhIHJlYWRlciBsb2NrIHdoZW4gdGhhdCByZWFkZXIgaGFzIHBlbmRpbmcgcmVhZCBjYWxscyB1bi1zZXR0bGVkJyk7XG5cdFx0fVxuXG5cdFx0dGhpcy5yZWxlYXNlKCk7XG5cdH1cblxuXHQvLyAzLjUuMTMuIFJlbGVhc2VSZWFkYWJsZVN0cmVhbVJlYWRlciAoIHJlYWRlciApXG5cdHJlbGVhc2UoKTogdm9pZCB7XG5cdFx0bGV0IHJlcXVlc3Q6IGFueTtcblx0XHRpZiAodGhpcy5fb3duZXJSZWFkYWJsZVN0cmVhbS5zdGF0ZSA9PT0gU3RhdGUuRXJyb3JlZCkge1xuXHRcdFx0dGhpcy5zdGF0ZSA9IFN0YXRlLkVycm9yZWQ7XG5cblx0XHRcdGNvbnN0IGUgPSB0aGlzLl9vd25lclJlYWRhYmxlU3RyZWFtLnN0b3JlZEVycm9yO1xuXHRcdFx0dGhpcy5fc3RvcmVkRXJyb3IgPSBlO1xuXHRcdFx0dGhpcy5fcmVqZWN0Q2xvc2VkUHJvbWlzZShlKTtcblxuXHRcdFx0Zm9yIChyZXF1ZXN0IG9mIHRoaXMuX3JlYWRSZXF1ZXN0cykge1xuXHRcdFx0XHRyZXF1ZXN0LnJlamVjdChlKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHR0aGlzLnN0YXRlID0gU3RhdGUuQ2xvc2VkO1xuXHRcdFx0dGhpcy5fcmVzb2x2ZUNsb3NlZFByb21pc2UoKTtcblx0XHRcdGZvciAocmVxdWVzdCBvZiB0aGlzLl9yZWFkUmVxdWVzdHMpIHtcblx0XHRcdFx0cmVxdWVzdC5yZXNvbHZlKHtcblx0XHRcdFx0XHR2YWx1ZTogdW5kZWZpbmVkLFxuXHRcdFx0XHRcdGRvbmU6IHRydWVcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0dGhpcy5fcmVhZFJlcXVlc3RzID0gW107XG5cdFx0dGhpcy5fb3duZXJSZWFkYWJsZVN0cmVhbS5yZWFkZXIgPSB1bmRlZmluZWQ7XG5cdFx0dGhpcy5fb3duZXJSZWFkYWJsZVN0cmVhbSA9IHVuZGVmaW5lZDtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXNvbHZlcyBhIHBlbmRpbmcgcmVhZCByZXF1ZXN0LCBpZiBhbnksIHdpdGggdGhlIHByb3ZpZGVkIGNodW5rLlxuXHQgKiBAcGFyYW0gY2h1bmtcblx0ICogQHJldHVybiBib29sZWFuIFRydWUgaWYgYSByZWFkIHJlcXVlc3Qgd2FzIHJlc29sdmVkLlxuXHQgKi9cblx0cmVzb2x2ZVJlYWRSZXF1ZXN0KGNodW5rOiBUKTogYm9vbGVhbiB7XG5cdFx0aWYgKHRoaXMuX3JlYWRSZXF1ZXN0cy5sZW5ndGggPiAwKSB7XG5cdFx0XHR0aGlzLl9yZWFkUmVxdWVzdHMuc2hpZnQoKS5yZXNvbHZlKHtcblx0XHRcdFx0dmFsdWU6IGNodW5rLFxuXHRcdFx0XHRkb25lOiBmYWxzZVxuXHRcdFx0fSk7XG5cdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHR9XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG59XG4iXX0=