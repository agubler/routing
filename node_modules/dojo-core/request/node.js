(function (factory) {
    if (typeof module === 'object' && typeof module.exports === 'object') {
        var v = factory(require, exports); if (v !== undefined) module.exports = v;
    }
    else if (typeof define === 'function' && define.amd) {
        define(["require", "exports", '../async/Task', './errors/RequestTimeoutError', 'http', 'https', '../lang', '../streams/adapters/ReadableNodeStreamSource', '../streams/adapters/WritableNodeStreamSink', '../streams/ReadableStream', '../streams/WritableStream', 'url', './util'], factory);
    }
})(function (require, exports) {
    "use strict";
    var Task_1 = require('../async/Task');
    var RequestTimeoutError_1 = require('./errors/RequestTimeoutError');
    var http = require('http');
    var https = require('https');
    var lang_1 = require('../lang');
    var ReadableNodeStreamSource_1 = require('../streams/adapters/ReadableNodeStreamSource');
    var WritableNodeStreamSink_1 = require('../streams/adapters/WritableNodeStreamSink');
    var ReadableStream_1 = require('../streams/ReadableStream');
    var WritableStream_1 = require('../streams/WritableStream');
    var urlUtil = require('url');
    var util_1 = require('./util');
    // TODO: Where should the dojo version come from? It used to be kernel, but we don't have that.
    var version = '2.0.0-pre';
    function node(url, options) {
        if (options === void 0) { options = {}; }
        var requestUrl = util_1.generateRequestUrl(url, options);
        var parsedUrl = urlUtil.parse(options.proxy || requestUrl);
        var requestOptions = {
            agent: options.agent,
            auth: parsedUrl.auth || options.auth,
            ca: options.ca,
            cert: options.cert,
            ciphers: options.ciphers,
            headers: options.headers || {},
            host: parsedUrl.host,
            hostname: parsedUrl.hostname,
            key: options.key,
            localAddress: options.localAddress,
            method: options.method ? options.method.toUpperCase() : 'GET',
            passphrase: options.passphrase,
            path: parsedUrl.path,
            pfx: options.pfx,
            port: Number(parsedUrl.port),
            rejectUnauthorized: options.rejectUnauthorized,
            secureProtocol: options.secureProtocol,
            socketPath: options.socketPath
        };
        if (!('user-agent' in requestOptions.headers)) {
            requestOptions.headers['user-agent'] = 'dojo/' + version + ' Node.js/' + process.version.replace(/^v/, '');
        }
        if (options.proxy) {
            requestOptions.path = requestUrl;
            if (parsedUrl.auth) {
                requestOptions.headers['proxy-authorization'] = 'Basic ' + new Buffer(parsedUrl.auth).toString('base64');
            }
            var _parsedUrl = urlUtil.parse(requestUrl);
            requestOptions.headers['host'] = _parsedUrl.host;
            requestOptions.auth = _parsedUrl.auth || options.auth;
        }
        if (!options.auth && (options.user || options.password)) {
            requestOptions.auth = encodeURIComponent(options.user || '') + ':' + encodeURIComponent(options.password || '');
        }
        var request = (parsedUrl.protocol === 'https:' ? https : http).request(requestOptions);
        var response = {
            data: null,
            getHeader: function (name) {
                return (this.nativeResponse && this.nativeResponse.headers[name.toLowerCase()]) || null;
            },
            requestOptions: options,
            statusCode: null,
            url: requestUrl
        };
        var promise = new Task_1.default(function (resolve, reject) {
            if (options.socketOptions) {
                if ('timeout' in options.socketOptions) {
                    request.setTimeout(options.socketOptions.timeout);
                }
                if ('noDelay' in options.socketOptions) {
                    request.setNoDelay(options.socketOptions.noDelay);
                }
                if ('keepAlive' in options.socketOptions) {
                    var initialDelay = options.socketOptions.keepAlive;
                    request.setSocketKeepAlive(initialDelay >= 0, initialDelay);
                }
            }
            var timeout;
            request.once('response', function (nativeResponse) {
                response.nativeResponse = nativeResponse;
                response.statusCode = nativeResponse.statusCode;
                // Redirection handling defaults to true in order to harmonise with the XHR provider, which will always
                // follow redirects
                // TODO: This redirect code is not 100% correct according to the RFC; needs to handle redirect loops and
                // restrict/modify certain redirects
                if (response.statusCode >= 300 &&
                    response.statusCode < 400 &&
                    response.statusCode !== 304 &&
                    options.followRedirects !== false &&
                    nativeResponse.headers.location) {
                    resolve(node(nativeResponse.headers.location, options));
                    return;
                }
                options.streamEncoding && nativeResponse.setEncoding(options.streamEncoding);
                if (options.streamTarget) {
                    var responseSource = new ReadableNodeStreamSource_1.default(nativeResponse);
                    var responseReadableStream = new ReadableStream_1.default(responseSource);
                    responseReadableStream.pipeTo(options.streamTarget)
                        .then(function () {
                        resolve(response);
                    }, function (error) {
                        options.streamTarget.abort(error);
                        request.abort();
                        error.response = response;
                        reject(error);
                    });
                }
                var data;
                var loaded;
                if (!options.streamData) {
                    data = [];
                    loaded = 0;
                    nativeResponse.on('data', function (chunk) {
                        data.push(chunk);
                        loaded += (typeof chunk === 'string') ?
                            Buffer.byteLength(chunk, options.streamEncoding) :
                            chunk.length;
                    });
                }
                nativeResponse.once('end', function () {
                    timeout && timeout.destroy();
                    if (!options.streamData) {
                        // TODO: what type should data have?
                        response.data = (options.streamEncoding ? data.join('') : Buffer.concat(data, loaded));
                    }
                    // If using a streamTarget, wait for it to finish in case it throws an error
                    if (!options.streamTarget) {
                        resolve(response);
                    }
                    else {
                        options.streamTarget.close();
                    }
                });
            });
            request.once('error', reject);
            if (options.data) {
                if (options.data instanceof ReadableStream_1.default) {
                    var requestSink = new WritableNodeStreamSink_1.default(request);
                    var writableRequest_1 = new WritableStream_1.default(requestSink);
                    options.data.pipeTo(writableRequest_1)
                        .catch(function (error) {
                        error.response = response;
                        writableRequest_1.abort(error);
                        reject(error);
                    });
                }
                else {
                    request.end(options.data);
                }
            }
            else {
                request.end();
            }
            if (options.timeout > 0 && options.timeout !== Infinity) {
                timeout = (function () {
                    var timer = setTimeout(function () {
                        var error = new RequestTimeoutError_1.default('Request timed out after ' + options.timeout + 'ms');
                        error.response = response;
                        reject(error);
                    }, options.timeout);
                    return lang_1.createHandle(function () {
                        clearTimeout(timer);
                    });
                })();
            }
        }, function () {
            request.abort();
        }).catch(function (error) {
            var parsedUrl = urlUtil.parse(url);
            if (parsedUrl.auth) {
                parsedUrl.auth = '(redacted)';
            }
            var sanitizedUrl = urlUtil.format(parsedUrl);
            error.message = '[' + requestOptions.method + ' ' + sanitizedUrl + '] ' + error.message;
            throw error;
        });
        return promise;
    }
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = node;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXF1ZXN0L25vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0lBQUEscUJBQWlCLGVBQWUsQ0FBQyxDQUFBO0lBQ2pDLG9DQUFnQyw4QkFBOEIsQ0FBQyxDQUFBO0lBRS9ELElBQVksSUFBSSxXQUFNLE1BQU0sQ0FBQyxDQUFBO0lBQzdCLElBQVksS0FBSyxXQUFNLE9BQU8sQ0FBQyxDQUFBO0lBQy9CLHFCQUE2QixTQUFTLENBQUMsQ0FBQTtJQUV2Qyx5Q0FBcUMsOENBQThDLENBQUMsQ0FBQTtJQUNwRix1Q0FBbUMsNENBQTRDLENBQUMsQ0FBQTtJQUNoRiwrQkFBMkIsMkJBQTJCLENBQUMsQ0FBQTtJQUN2RCwrQkFBMkIsMkJBQTJCLENBQUMsQ0FBQTtJQUN2RCxJQUFZLE9BQU8sV0FBTSxLQUFLLENBQUMsQ0FBQTtJQUMvQixxQkFBbUMsUUFBUSxDQUFDLENBQUE7SUFFNUMsK0ZBQStGO0lBQy9GLElBQUksT0FBTyxHQUFHLFdBQVcsQ0FBQztJQW1EMUIsY0FBZ0MsR0FBVyxFQUFFLE9BQW1DO1FBQW5DLHVCQUFtQyxHQUFuQyxZQUFtQztRQUMvRSxJQUFNLFVBQVUsR0FBRyx5QkFBa0IsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDcEQsSUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLFVBQVUsQ0FBQyxDQUFDO1FBQzdELElBQU0sY0FBYyxHQUFpQjtZQUNwQyxLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7WUFDcEIsSUFBSSxFQUFFLFNBQVMsQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDLElBQUk7WUFDcEMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxFQUFFO1lBQ2QsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1lBQ2xCLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTztZQUN4QixPQUFPLEVB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LEVBQUUsQ0FBQztZQUNOLENBQUM7UUFDRixDQUFDLEVBQUU7WUFDRixPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDakIsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsS0FBWTtZQUM5QixJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRW5DLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNwQixTQUFTLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQztZQUMvQixDQUFDO1lBRUQsSUFBSSxZQUFZLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUU3QyxLQUFLLENBQUMsT0FBTyxHQUFHLEdBQUcsR0FBRyxjQUFjLENBQUMsTUFBTSxHQUFHLEdBQUcsR0FBRyxZQUFZLEdBQUcsSUFBSSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7WUFDeEYsTUFBTSxLQUFLLENBQUM7UUFDYixDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxPQUFPLENBQUM7SUFDaEIsQ0FBQztJQS9MRDswQkErTEMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBUYXNrIGZyb20gJy4uL2FzeW5jL1Rhc2snO1xuaW1wb3J0IFJlcXVlc3RUaW1lb3V0RXJyb3IgZnJvbSAnLi9lcnJvcnMvUmVxdWVzdFRpbWVvdXRFcnJvcic7XG5pbXBvcnQgeyBIYW5kbGUgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgKiBhcyBodHRwcyBmcm9tICdodHRwcyc7XG5pbXBvcnQgeyBjcmVhdGVIYW5kbGUgfSBmcm9tICcuLi9sYW5nJztcbmltcG9ydCB7IFJlcXVlc3RFcnJvciwgUmVxdWVzdE9wdGlvbnMsIFJlc3BvbnNlLCBSZXNwb25zZVByb21pc2UgfSBmcm9tICcuLi9yZXF1ZXN0JztcbmltcG9ydCBSZWFkYWJsZU5vZGVTdHJlYW1Tb3VyY2UgZnJvbSAnLi4vc3RyZWFtcy9hZGFwdGVycy9SZWFkYWJsZU5vZGVTdHJlYW1Tb3VyY2UnO1xuaW1wb3J0IFdyaXRhYmxlTm9kZVN0cmVhbVNpbmsgZnJvbSAnLi4vc3RyZWFtcy9hZGFwdGVycy9Xcml0YWJsZU5vZGVTdHJlYW1TaW5rJztcbmltcG9ydCBSZWFkYWJsZVN0cmVhbSBmcm9tICcuLi9zdHJlYW1zL1JlYWRhYmxlU3RyZWFtJztcbmltcG9ydCBXcml0YWJsZVN0cmVhbSBmcm9tICcuLi9zdHJlYW1zL1dyaXRhYmxlU3RyZWFtJztcbmltcG9ydCAqIGFzIHVybFV0aWwgZnJvbSAndXJsJztcbmltcG9ydCB7IGdlbmVyYXRlUmVxdWVzdFVybCB9IGZyb20gJy4vdXRpbCc7XG5cbi8vIFRPRE86IFdoZXJlIHNob3VsZCB0aGUgZG9qbyB2ZXJzaW9uIGNvbWUgZnJvbT8gSXQgdXNlZCB0byBiZSBrZXJuZWwsIGJ1dCB3ZSBkb24ndCBoYXZlIHRoYXQuXG5sZXQgdmVyc2lvbiA9ICcyLjAuMC1wcmUnO1xuXG5pbnRlcmZhY2UgT3B0aW9ucyB7XG5cdGFnZW50PzogYW55O1xuXHRhdXRoPzogc3RyaW5nO1xuXHRoZWFkZXJzPzogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nOyB9O1xuXHRob3N0Pzogc3RyaW5nO1xuXHRob3N0bmFtZT86IHN0cmluZztcblx0bG9jYWxBZGRyZXNzPzogc3RyaW5nO1xuXHRtZXRob2Q/OiBzdHJpbmc7XG5cdHBhdGg/OiBzdHJpbmc7XG5cdHBvcnQ/OiBudW1iZXI7XG5cdHNvY2tldFBhdGg/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBIdHRwc09wdGlvbnMgZXh0ZW5kcyBPcHRpb25zIHtcblx0Y2E/OiBhbnk7XG5cdGNlcnQ/OiBzdHJpbmc7XG5cdGNpcGhlcnM/OiBzdHJpbmc7XG5cdGtleT86IHN0cmluZztcblx0cGFzc3BocmFzZT86IHN0cmluZztcblx0cGZ4PzogYW55O1xuXHRyZWplY3RVbmF1dGhvcml6ZWQ/OiBib29sZWFuO1xuXHRzZWN1cmVQcm90b2NvbD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOb2RlUmVxdWVzdE9wdGlvbnM8VD4gZXh0ZW5kcyBSZXF1ZXN0T3B0aW9ucyB7XG5cdGFnZW50PzogYW55O1xuXHRjYT86IGFueTtcblx0Y2VydD86IHN0cmluZztcblx0Y2lwaGVycz86IHN0cmluZztcblx0ZGF0YUVuY29kaW5nPzogc3RyaW5nO1xuXHRmb2xsb3dSZWRpcmVjdHM/OiBib29sZWFuO1xuXHRrZXk/OiBzdHJpbmc7XG5cdGxvY2FsQWRkcmVzcz86IHN0cmluZztcblx0cGFzc3BocmFzZT86IHN0cmluZztcblx0cGZ4PzogYW55O1xuXHRwcm94eT86IHN0cmluZztcblx0cmVqZWN0VW5hdXRob3JpemVkPzogYm9vbGVhbjtcblx0c2VjdXJlUHJvdG9jb2w/OiBzdHJpbmc7XG5cdHNvY2tldFBhdGg/OiBzdHJpbmc7XG5cdHNvY2tldE9wdGlvbnM/OiB7XG5cdFx0a2VlcEFsaXZlPzogbnVtYmVyO1xuXHRcdG5vRGVsYXk/OiBib29sZWFuO1xuXHRcdHRpbWVvdXQ/OiBudW1iZXI7XG5cdH07XG5cdHN0cmVhbURhdGE/OiBib29sZWFuO1xuXHRzdHJlYW1FbmNvZGluZz86IHN0cmluZztcblx0c3RyZWFtVGFyZ2V0PzogV3JpdGFibGVTdHJlYW08VD47XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIG5vZGU8VD4odXJsOiBzdHJpbmcsIG9wdGlvbnM6IE5vZGVSZXF1ZXN0T3B0aW9uczxUPiA9IHt9KTogUmVzcG9uc2VQcm9taXNlPFQ+IHtcblx0Y29uc3QgcmVxdWVzdFVybCA9IGdlbmVyYXRlUmVxdWVzdFVybCh1cmwsIG9wdGlvbnMpO1xuXHRjb25zdCBwYXJzZWRVcmwgPSB1cmxVdGlsLnBhcnNlKG9wdGlvbnMucHJveHkgfHwgcmVxdWVzdFVybCk7XG5cdGNvbnN0IHJlcXVlc3RPcHRpb25zOiBIdHRwc09wdGlvbnMgPSB7XG5cdFx0YWdlbnQ6IG9wdGlvbnMuYWdlbnQsXG5cdFx0YXV0aDogcGFyc2VkVXJsLmF1dGggfHwgb3B0aW9ucy5hdXRoLFxuXHRcdGNhOiBvcHRpb25zLmNhLFxuXHRcdGNlcnQ6IG9wdGlvbnMuY2VydCxcblx0XHRjaXBoZXJzOiBvcHRpb25zLmNpcGhlcnMsXG5cdFx0aGVhZGVyczogb3B0aW9ucy5oZWFkZXJzIHx8IHt9LFxuXHRcdGhvc3Q6IHBhcnNlZFVybC5ob3N0LFxuXHRcdGhvc3RuYW1lOiBwYXJzZWRVcmwuaG9zdG5hbWUsXG5cdFx0a2V5OiBvcHRpb25zLmtleSxcblx0XHRsb2NhbEFkZHJlc3M6IG9wdGlvbnMubG9jYWxBZGRyZXNzLFxuXHRcdG1ldGhvZDogb3B0aW9ucy5tZXRob2QgPyBvcHRpb25zLm1ldGhvZC50b1VwcGVyQ2FzZSgpIDogJ0dFVCcsXG5cdFx0cGFzc3BocmFzZTogb3B0aW9ucy5wYXNzcGhyYXNlLFxuXHRcdHBhdGg6IHBhcnNlZFVybC5wYXRoLFxuXHRcdHBmeDogb3B0aW9ucy5wZngsXG5cdFx0cG9ydDogTnVtYmVyKHBhcnNlZFVybC5wb3J0KSxcblx0XHRyZWplY3RVbmF1dGhvcml6ZWQ6IG9wdGlvbnMucmVqZWN0VW5hdXRob3JpemVkLFxuXHRcdHNlY3VyZVByb3RvY29sOiBvcHRpb25zLnNlY3VyZVByb3RvY29sLFxuXHRcdHNvY2tldFBhdGg6IG9wdGlvbnMuc29ja2V0UGF0aFxuXHR9O1xuXG5cdGlmICghKCd1c2VyLWFnZW50JyBpbiByZXF1ZXN0T3B0aW9ucy5oZWFkZXJzKSkge1xuXHRcdHJlcXVlc3RPcHRpb25zLmhlYWRlcnNbJ3VzZXItYWdlbnQnXSA9ICdkb2pvLycgKyB2ZXJzaW9uICsgJyBOb2RlLmpzLycgKyBwcm9jZXNzLnZlcnNpb24ucmVwbGFjZSgvXnYvLCAnJyk7XG5cdH1cblxuXHRpZiAob3B0aW9ucy5wcm94eSkge1xuXHRcdHJlcXVlc3RPcHRpb25zLnBhdGggPSByZXF1ZXN0VXJsO1xuXHRcdGlmIChwYXJzZWRVcmwuYXV0aCkge1xuXHRcdFx0cmVxdWVzdE9wdGlvbnMuaGVhZGVyc1sncHJveHktYXV0aG9yaXphdGlvbiddID0gJ0Jhc2ljICcgKyBuZXcgQnVmZmVyKHBhcnNlZFVybC5hdXRoKS50b1N0cmluZygnYmFzZTY0Jyk7XG5cdFx0fVxuXG5cdFx0bGV0IF9wYXJzZWRVcmwgPSB1cmxVdGlsLnBhcnNlKHJlcXVlc3RVcmwpO1xuXHRcdHJlcXVlc3RPcHRpb25zLmhlYWRlcnNbJ2hvc3QnXSA9IF9wYXJzZWRVcmwuaG9zdDtcblx0XHRyZXF1ZXN0T3B0aW9ucy5hdXRoID0gX3BhcnNlZFVybC5hdXRoIHx8IG9wdGlvbnMuYXV0aDtcblx0fVxuXG5cdGlmICghb3B0aW9ucy5hdXRoICYmIChvcHRpb25zLnVzZXIgfHwgb3B0aW9ucy5wYXNzd29yZCkpIHtcblx0XHRyZXF1ZXN0T3B0aW9ucy5hdXRoID0gZW5jb2RlVVJJQ29tcG9uZW50KG9wdGlvbnMudXNlciB8fCAnJykgKyAnOicgKyBlbmNvZGVVUklDb21wb25lbnQob3B0aW9ucy5wYXNzd29yZCB8fCAnJyk7XG5cdH1cblxuXHRjb25zdCByZXF1ZXN0ID0gKHBhcnNlZFVybC5wcm90b2NvbCA9PT0gJ2h0dHBzOicgPyBodHRwcyA6IGh0dHApLnJlcXVlc3QocmVxdWVzdE9wdGlvbnMpO1xuXHRjb25zdCByZXNwb25zZTogUmVzcG9uc2U8VD4gPSB7XG5cdFx0ZGF0YTogbnVsbCxcblx0XHRnZXRIZWFkZXI6IGZ1bmN0aW9uIChuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuXHRcdFx0cmV0dXJuICh0aGlzLm5hdGl2ZVJlc3BvbnNlICYmIHRoaXMubmF0aXZlUmVzcG9uc2UuaGVhZGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldKSB8fCBudWxsO1xuXHRcdH0sXG5cdFx0cmVxdWVzdE9wdGlvbnM6IG9wdGlvbnMsXG5cdFx0c3RhdHVzQ29kZTogbnVsbCxcblx0XHR1cmw6IHJlcXVlc3RVcmxcblx0fTtcblxuXHRjb25zdCBwcm9taXNlID0gbmV3IFRhc2s8UmVzcG9uc2U8VD4+KGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcblx0XHRpZiAob3B0aW9ucy5zb2NrZXRPcHRpb25zKSB7XG5cdFx0XHRpZiAoJ3RpbWVvdXQnIGluIG9wdGlvbnMuc29ja2V0T3B0aW9ucykge1xuXHRcdFx0XHRyZXF1ZXN0LnNldFRpbWVvdXQob3B0aW9ucy5zb2NrZXRPcHRpb25zLnRpbWVvdXQpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoJ25vRGVsYXknIGluIG9wdGlvbnMuc29ja2V0T3B0aW9ucykge1xuXHRcdFx0XHRyZXF1ZXN0LnNldE5vRGVsYXkob3B0aW9ucy5zb2NrZXRPcHRpb25zLm5vRGVsYXkpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoJ2tlZXBBbGl2ZScgaW4gb3B0aW9ucy5zb2NrZXRPcHRpb25zKSB7XG5cdFx0XHRcdGNvbnN0IGluaXRpYWxEZWxheTogbnVtYmVyID0gb3B0aW9ucy5zb2NrZXRPcHRpb25zLmtlZXBBbGl2ZTtcblx0XHRcdFx0cmVxdWVzdC5zZXRTb2NrZXRLZWVwQWxpdmUoaW5pdGlhbERlbGF5ID49IDAsIGluaXRpYWxEZWxheSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0bGV0IHRpbWVvdXQ6IEhhbmRsZTtcblx0XHRyZXF1ZXN0Lm9uY2UoJ3Jlc3BvbnNlJywgZnVuY3Rpb24gKG5hdGl2ZVJlc3BvbnNlOiBodHRwLkNsaWVudFJlc3BvbnNlKTogdm9pZCB7XG5cdFx0XHRyZXNwb25zZS5uYXRpdmVSZXNwb25zZSA9IG5hdGl2ZVJlc3BvbnNlO1xuXHRcdFx0cmVzcG9uc2Uuc3RhdHVzQ29kZSA9IG5hdGl2ZVJlc3BvbnNlLnN0YXR1c0NvZGU7XG5cblx0XHRcdC8vIFJlZGlyZWN0aW9uIGhhbmRsaW5nIGRlZmF1bHRzIHRvIHRydWUgaW4gb3JkZXIgdG8gaGFybW9uaXNlIHdpdGggdGhlIFhIUiBwcm92aWRlciwgd2hpY2ggd2lsbCBhbHdheXNcblx0XHRcdC8vIGZvbGxvdyByZWRpcmVjdHNcblx0XHRcdC8vIFRPRE86IFRoaXMgcmVkaXJlY3QgY29kZSBpcyBub3QgMTAwJSBjb3JyZWN0IGFjY29yZGluZyB0byB0aGUgUkZDOyBuZWVkcyB0byBoYW5kbGUgcmVkaXJlY3QgbG9vcHMgYW5kXG5cdFx0XHQvLyByZXN0cmljdC9tb2RpZnkgY2VydGFpbiByZWRpcmVjdHNcblx0XHRcdGlmIChcblx0XHRcdFx0cmVzcG9uc2Uuc3RhdHVzQ29kZSA+PSAzMDAgJiZcblx0XHRcdFx0cmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDQwMCAmJlxuXHRcdFx0XHRyZXNwb25zZS5zdGF0dXNDb2RlICE9PSAzMDQgJiZcblx0XHRcdFx0b3B0aW9ucy5mb2xsb3dSZWRpcmVjdHMgIT09IGZhbHNlICYmXG5cdFx0XHRcdG5hdGl2ZVJlc3BvbnNlLmhlYWRlcnMubG9jYXRpb25cblx0XHRcdCkge1xuXHRcdFx0XHRyZXNvbHZlKG5vZGUobmF0aXZlUmVzcG9uc2UuaGVhZGVycy5sb2NhdGlvbiwgb3B0aW9ucykpO1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cblx0XHRcdG9wdGlvbnMuc3RyZWFtRW5jb2RpbmcgJiYgbmF0aXZlUmVzcG9uc2Uuc2V0RW5jb2Rpbmcob3B0aW9ucy5zdHJlYW1FbmNvZGluZyk7XG5cdFx0XHRpZiAob3B0aW9ucy5zdHJlYW1UYXJnZXQpIHtcblx0XHRcdFx0Y29uc3QgcmVzcG9uc2VTb3VyY2UgPSBuZXcgUmVhZGFibGVOb2RlU3RyZWFtU291cmNlKG5hdGl2ZVJlc3BvbnNlKTtcblx0XHRcdFx0Y29uc3QgcmVzcG9uc2VSZWFkYWJsZVN0cmVhbSA9IG5ldyBSZWFkYWJsZVN0cmVhbShyZXNwb25zZVNvdXJjZSk7XG5cblx0XHRcdFx0cmVzcG9uc2VSZWFkYWJsZVN0cmVhbS5waXBlVG8oPGFueT4gb3B0aW9ucy5zdHJlYW1UYXJnZXQpXG5cdFx0XHRcdFx0LnRoZW4oXG5cdFx0XHRcdFx0XHRmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdFx0XHRcdHJlc29sdmUocmVzcG9uc2UpO1xuXHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdGZ1bmN0aW9uIChlcnJvcjogUmVxdWVzdEVycm9yPFQ+KSB7XG5cdFx0XHRcdFx0XHRcdG9wdGlvbnMuc3RyZWFtVGFyZ2V0LmFib3J0KGVycm9yKTtcblx0XHRcdFx0XHRcdFx0cmVxdWVzdC5hYm9ydCgpO1xuXHRcdFx0XHRcdFx0XHRlcnJvci5yZXNwb25zZSA9IHJlc3BvbnNlO1xuXHRcdFx0XHRcdFx0XHRyZWplY3QoZXJyb3IpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdCk7XG5cdFx0XHR9XG5cblx0XHRcdGxldCBkYXRhOiBhbnlbXTtcblx0XHRcdGxldCBsb2FkZWQ6IG51bWJlcjtcblx0XHRcdGlmICghb3B0aW9ucy5zdHJlYW1EYXRhKSB7XG5cdFx0XHRcdGRhdGEgPSBbXTtcblx0XHRcdFx0bG9hZGVkID0gMDtcblxuXHRcdFx0XHRuYXRpdmVSZXNwb25zZS5vbignZGF0YScsIGZ1bmN0aW9uIChjaHVuazogYW55KTogdm9pZCB7XG5cdFx0XHRcdFx0ZGF0YS5wdXNoKGNodW5rKTtcblx0XHRcdFx0XHRsb2FkZWQgKz0gKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpID9cblx0XHRcdFx0XHRcdEJ1ZmZlci5ieXRlTGVuZ3RoKGNodW5rLCBvcHRpb25zLnN0cmVhbUVuY29kaW5nKSA6XG5cdFx0XHRcdFx0XHRjaHVuay5sZW5ndGg7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRuYXRpdmVSZXNwb25zZS5vbmNlKCdlbmQnLCBmdW5jdGlvbiAoKTogdm9pZCB7XG5cdFx0XHRcdHRpbWVvdXQgJiYgdGltZW91dC5kZXN0cm95KCk7XG5cblx0XHRcdFx0aWYgKCFvcHRpb25zLnN0cmVhbURhdGEpIHtcblx0XHRcdFx0XHQvLyBUT0RPOiB3aGF0IHR5cGUgc2hvdWxkIGRhdGEgaGF2ZT9cblx0XHRcdFx0XHRyZXNwb25zZS5kYXRhID0gPGFueT4gKG9wdGlvbnMuc3RyZWFtRW5jb2RpbmcgPyBkYXRhLmpvaW4oJycpIDogQnVmZmVyLmNvbmNhdChkYXRhLCBsb2FkZWQpKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdC8vIElmIHVzaW5nIGEgc3RyZWFtVGFyZ2V0LCB3YWl0IGZvciBpdCB0byBmaW5pc2ggaW4gY2FzZSBpdCB0aHJvd3MgYW4gZXJyb3Jcblx0XHRcdFx0aWYgKCFvcHRpb25zLnN0cmVhbVRhcmdldCkge1xuXHRcdFx0XHRcdHJlc29sdmUocmVzcG9uc2UpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdG9wdGlvbnMuc3RyZWFtVGFyZ2V0LmNsb3NlKCk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdH0pO1xuXG5cdFx0cmVxdWVzdC5vbmNlKCdlcnJvcicsIHJlamVjdCk7XG5cblx0XHRpZiAob3B0aW9ucy5kYXRhKSB7XG5cdFx0XHRpZiAob3B0aW9ucy5kYXRhIGluc3RhbmNlb2YgUmVhZGFibGVTdHJlYW0pIHtcblx0XHRcdFx0Y29uc3QgcmVxdWVzdFNpbmsgPSBuZXcgV3JpdGFibGVOb2RlU3RyZWFtU2luayhyZXF1ZXN0KTtcblx0XHRcdFx0Y29uc3Qgd3JpdGFibGVSZXF1ZXN0ID0gbmV3IFdyaXRhYmxlU3RyZWFtKHJlcXVlc3RTaW5rKTtcblx0XHRcdFx0b3B0aW9ucy5kYXRhLnBpcGVUbyh3cml0YWJsZVJlcXVlc3QpXG5cdFx0XHRcdFx0LmNhdGNoKGZ1bmN0aW9uIChlcnJvcjogUmVxdWVzdEVycm9yPFQ+KSB7XG5cdFx0XHRcdFx0XHRlcnJvci5yZXNwb25zZSA9IHJlc3BvbnNlO1xuXHRcdFx0XHRcdFx0d3JpdGFibGVSZXF1ZXN0LmFib3J0KGVycm9yKTtcblx0XHRcdFx0XHRcdHJlamVjdChlcnJvcik7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0XHRlbHNlIHtcblx0XHRcdFx0cmVxdWVzdC5lbmQob3B0aW9ucy5kYXRhKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHRyZXF1ZXN0LmVuZCgpO1xuXHRcdH1cblxuXHRcdGlmIChvcHRpb25zLnRpbWVvdXQgPiAwICYmIG9wdGlvbnMudGltZW91dCAhPT0gSW5maW5pdHkpIHtcblx0XHRcdHRpbWVvdXQgPSAoZnVuY3Rpb24gKCk6IEhhbmRsZSB7XG5cdFx0XHRcdGNvbnN0IHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKTogdm9pZCB7XG5cdFx0XHRcdFx0Y29uc3QgZXJyb3IgPSBuZXcgUmVxdWVzdFRpbWVvdXRFcnJvcignUmVxdWVzdCB0aW1lZCBvdXQgYWZ0ZXIgJyArIG9wdGlvbnMudGltZW91dCArICdtcycpO1xuXHRcdFx0XHRcdGVycm9yLnJlc3BvbnNlID0gcmVzcG9uc2U7XG5cdFx0XHRcdFx0cmVqZWN0KGVycm9yKTtcblx0XHRcdFx0fSwgb3B0aW9ucy50aW1lb3V0KTtcblxuXHRcdFx0XHRyZXR1cm4gY3JlYXRlSGFuZGxlKGZ1bmN0aW9uICgpOiB2b2lkIHtcblx0XHRcdFx0XHRjbGVhclRpbWVvdXQodGltZXIpO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0pKCk7XG5cdFx0fVxuXHR9LCBmdW5jdGlvbiAoKSB7XG5cdFx0cmVxdWVzdC5hYm9ydCgpO1xuXHR9KS5jYXRjaChmdW5jdGlvbiAoZXJyb3I6IEVycm9yKTogYW55IHtcblx0XHRsZXQgcGFyc2VkVXJsID0gdXJsVXRpbC5wYXJzZSh1cmwpO1xuXG5cdFx0aWYgKHBhcnNlZFVybC5hdXRoKSB7XG5cdFx0XHRwYXJzZWRVcmwuYXV0aCA9ICcocmVkYWN0ZWQpJztcblx0XHR9XG5cblx0XHRsZXQgc2FuaXRpemVkVXJsID0gdXJsVXRpbC5mb3JtYXQocGFyc2VkVXJsKTtcblxuXHRcdGVycm9yLm1lc3NhZ2UgPSAnWycgKyByZXF1ZXN0T3B0aW9ucy5tZXRob2QgKyAnICcgKyBzYW5pdGl6ZWRVcmwgKyAnXSAnICsgZXJyb3IubWVzc2FnZTtcblx0XHR0aHJvdyBlcnJvcjtcblx0fSk7XG5cblx0cmV0dXJuIHByb21pc2U7XG59XG4iXX0=